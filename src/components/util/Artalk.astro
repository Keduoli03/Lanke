
<!-- 1. 先静态显示阅读量/评论数的骨架屏 -->
<div class="flex justify-between items-center text-75 mb-4">
  <div class="flex items-center">
    阅读量: <span class="artalk-pv-count ml-1">--</span>
  </div>
  <div class="flex items-center">
    评论数：<span class="artalk-comment-count ml-1">--</span>
  </div>
</div>

<div id="Comments"></div>

<script is:inline>
  async function initArtalk() {
    const container = document.getElementById('Comments');
    if (!container) return;
    
    // To prevent re-initialization issues, clear the container.
    container.innerHTML = '';

    // Load CSS if not already present
    if (!document.querySelector('link[href="https://unpkg.com/artalk@2.9.1/dist/Artalk.css"]')) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://unpkg.com/artalk@2.9.1/dist/Artalk.css';
      document.head.appendChild(link);
    }

    const ArtalkModule = await import('https://esm.sh/artalk@2.9.1');
    const Artalk = ArtalkModule.default || ArtalkModule;

    // Normalize the path to ensure consistency
    let path = window.location.pathname;
    if (path.length > 1 && path.endsWith('/')) {
      path = path.slice(0, -1);
    }

    Artalk.init({
      el: '#Comments',
      server: 'https://artalk.blueke.top/',
      site: "Lanke",
      pageKey: path,
      pageTitle: document.title,
      locale: 'zh-CN',
      noComment: '快来评论吧！',
      darkMode: document.documentElement.classList.contains('dark'),
      avatar: {
        default: '/favicon.ico', // 使用你现有的logo作为默认头像
        gravatar: {
          mirror: 'https://cravatar.cn/avatar/'
        }
      }
    });
  }

  // Initialize on page load and view transitions
  document.addEventListener('astro:page-load', initArtalk);

  // Set up a theme change observer only once
  if (!window.artalkThemeObserver) {
    const observer = new MutationObserver(() => {
      // Re-initialize Artalk on theme change
      initArtalk();
    });
    
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['class']
    });

    window.artalkThemeObserver = true;
  }
</script>