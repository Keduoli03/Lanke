---
import { Icon } from "astro-icon/components";
import { navBarConfig, siteConfig } from "../config";
import type { NavBarLink } from "../types/config";
import { url } from "../utils/url-utils";
import LightDarkSwitch from "./util/LightDarkSwitch.svelte";
import ThemeSwitch from "./util/ThemeSwitch.svelte";

let links: NavBarLink[] = Object.values(navBarConfig.links);
const currentPath = Astro.url.pathname;

type ExtendedLink = NavBarLink;

const extendedLinks: ExtendedLink[] = [...links];
---


  <div
    id="sidebar"
    class="relative h-full bg-[var(--sidebar-bg)] flex-col transition-all duration-300 ease lg:flex hidden"
    style={`--sidebar-width-narrow: ${siteConfig.sidebarWidth}; --sidebar-width-wide: ${siteConfig.sidebarExtendWidth};`}
  >
  <div class="sidebar-header p-2 border-b border-[var(--line-divider)] flex items-center justify-center relative">
    <!-- Logo容器：折叠/展开时都保持居中对齐 -->
    <a href={url("/")} class="hover:opacity-80 transition-opacity flex items-center justify-center" data-no-lightbox="true">
      <img src="/favicon-192.png" alt={siteConfig.title} class="sidebar-logo w-10 h-10" data-no-lightbox="true" loading="eager" decoding="async" fetchpriority="high" />
      <span class="text-sm font-semibold text-[var(--text-primary)] sidebar-text">
        {siteConfig.title}
      </span>
    </a>
    <!-- 展开按钮：固定在右侧，不影响Logo -->
    <button id="sidebar-toggle" class="sidebar-toggle toggle-pill">
      <Icon name="ri:arrow-right-s-line" class="h-3 w-3 text-black" />
    </button>
  </div>

  <nav class="p-2 overflow-y-scroll" style="scrollbar-width: none;">
    <ul class="space-y-2 py-1">
      {extendedLinks.map((l) => {
        const isExternal = !!l.external || /^https?:\/\//.test(l.url);
        const linkPath = isExternal ? l.url : url(l.url);
        const isActive = !isExternal && (linkPath === '/' ? currentPath === '/' : currentPath.startsWith(linkPath));
        
        

        return (
          <li class="flex justify-center">
            <a
              href={linkPath}
              target={isExternal ? "_blank" : "_self"}
              rel={isExternal ? "noopener noreferrer" : ""}
              class:list={[
                "group flex items-center p-1 nav-link rounded-lg transition-all duration-300",
                { "is-active": isActive },
              ]}
            >
              <div class="icon-container w-8 h-8 rounded-lg flex items-center justify-center relative shadow-md border-2 border-transparent group-hover:border-[var(--theme-color-light)]" style="background-color: var(--sidebar-icon-bg)">
                {l.icon && <Icon name={l.icon} class="icon h-5 w-5" />}
              </div>
              <span class="text-xs text-[var(--text-secondary)] font-medium sidebar-text">
                {l.name}
              </span>
              {isExternal && (
                <Icon
                  name="material-symbols:link"
                  class="external-indicator h-4 w-4 text-[var(--text-secondary)]/70 ml-auto"
                />
              )}
            </a>
          </li>
        );
      })}
    </ul>
  </nav>

  <aside class="p-2 border-t border-[var(--line-divider)]">
    <div class="bottom-bar flex flex-col items-center gap-2">
      <button id="open-search-btn" class="w-full flex items-center p-1 nav-link rounded-lg">
        <div class="icon-container w-8 h-8 rounded-lg flex items-center justify-center relative shadow-md" style="background-color: var(--sidebar-icon-bg)">
          <Icon name="ri:search-line" class="icon h-5 w-5" />
        </div>
        <span class="text-xs text-[var(--text-secondary)] font-medium sidebar-text">搜索</span>
      </button>
      <div id="theme-mode-item" class="w-full flex items-center p-1 nav-link rounded-lg">
        <div class="icon-container w-8 h-8 rounded-lg flex items-center justify-center relative shadow-md" style="background-color: var(--sidebar-icon-bg)">
          <LightDarkSwitch client:load>
            <Icon slot="dark-icon" name="material-symbols:dark-mode-outline" class="icon h-5 w-5 cursor-pointer" />
            <Icon slot="light-icon" name="material-symbols:light-mode-outline" class="icon h-5 w-5 cursor-pointer" />
          </LightDarkSwitch>
        </div>
        <span id="theme-mode-label" class="text-xs text-[var(--text-secondary)] font-medium sidebar-text">模式</span>
      </div>
      <div id="theme-color-item" class="w-full flex items-center p-1 nav-link rounded-lg">
        <div class="icon-container w-8 h-8 rounded-lg flex items-center justify-center relative shadow-md" style="background-color: var(--sidebar-icon-bg)">
          <ThemeSwitch client:load isMobile={false}>
            <Icon slot="palette-icon" name="material-symbols:palette-outline" class="icon h-5 w-5 cursor-pointer" />
            <Icon slot="reset-icon" name="fa6-solid:arrow-rotate-left" class="text-xs" />
          </ThemeSwitch>
        </div>
        <span class="text-xs text-[var(--text-secondary)] font-medium sidebar-text">配色</span>
      </div>
    </div>
  </aside>
</div>

<style>
  #sidebar {
    width: var(--sidebar-width-narrow);
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    z-index: 10;
    box-shadow: 2px 0 10px -5px rgba(0, 0, 0, 0.05);
    transition: width 300ms ease, box-shadow 0.3s ease;
    display: grid;
    grid-template-rows: 60px 1fr auto;
    --bottom-bar-height: 4.5rem;
  }

  html.no-sidebar-transition #sidebar {
    transition: none !important;
  }
  html.no-sidebar-transition #sidebar * {
    transition: none !important;
    animation: none !important;
  }
  html.no-sidebar-transition #sidebar .icon-container {
    transform: none !important;
  }

  /* 展开状态：仅依赖 html 属性，避免 dataset 切换导致宽度抖动 */
  html[data-sidebar-open="true"] #sidebar {
    width: var(--sidebar-width-wide);
    /* 展开时使用标准缓动 */
    transition: width 300ms cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s ease;
  }

  /* 收起时：稍微快一点 */
  html[data-sidebar-open="false"] #sidebar {
    transition: width 250ms cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s ease;
  }

  @media (min-width: 1024px) and (max-width: 1440px) {
    #sidebar { --sidebar-width-narrow: var(--tablet-sidebar-width); }
    html[data-sidebar-open="true"] #sidebar { width: var(--tablet-sidebar-extend-width); }
  }

  html.dark #sidebar {
    box-shadow: 2px 0 12px -5px rgba(0, 0, 0, 0.2);
  }

  /* 头部关键样式：固定高度+两端对齐，确保Logo和按钮不重合 */
  .sidebar-header {
    height: 60px; /* 和菜单图标行高一致 */
    width: 100%;
    box-sizing: border-box;
    /* 移除 overflow: hidden，否则会裁剪掉右侧绝对定位的展开按钮 */
  }

  /* 折叠/展开文本切换：精细控制 opacity 和 占位 */
  .sidebar-text {
    opacity: 0;
    width: 0;           /* 收起时宽度为0，不占位，避免挤偏Logo */
    margin-left: 0;     /* 收起时去掉间距 */
    white-space: nowrap;
    overflow: hidden;
    /* 收起时：各项属性快速复位 */
    transition: opacity 100ms ease, width 200ms ease, margin-left 200ms ease; 
  }

  /* 展开状态下：文字显示 */
  html[data-sidebar-open="true"] #sidebar .sidebar-text,
  #sidebar[data-open="1"] .sidebar-text {
    opacity: 1;
    width: auto;        /* 恢复宽度 */
    margin-left: 0.5rem; /* 恢复间距 (对应 ml-2) */
    /* 展开时：增加延迟到 300ms，确保侧边栏宽度动画（300ms）完成后再开始显示文字 */
    transition: opacity 200ms ease 300ms, width 200ms ease, margin-left 200ms ease; 
  }

  /* 特殊处理：折叠状态下的主导航文字（显示在图标下方） */
  html[data-sidebar-open="false"] #sidebar nav .nav-link .sidebar-text {
    opacity: 1;
    width: auto;
    margin-left: 0;
    margin-top: 0.25rem;
    font-size: 0.75rem;
    text-align: center;
    transition: opacity 100ms ease;
  }

  html[data-sidebar-open="false"] #sidebar .bottom-bar .sidebar-text {
    display: none;
  }


  .sidebar-logo {
    width: 2.5rem; /* 等于w-10 */
    height: 2.5rem;
    flex-shrink: 0;
  }


  #sidebar-toggle {
    border: none;
    cursor: pointer;
    transition: transform 0.3s ease;
  }
  .toggle-pill {
    position: absolute;
    right: -12px;
    top: 50%;
    transform: translateY(-50%);
    width: 24px;
    height: 24px;
    border-radius: 9999px;
    background: color-mix(in srgb, var(--theme-color) 20%, white);
    color: #fff;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px -2px rgba(0,0,0,0.2);
    z-index: 20;
  }

  html[data-sidebar-open="true"] #sidebar #sidebar-toggle {
    transform: translateY(-50%) rotate(180deg);
  }

  /* 菜单图标容器：和Logo尺寸统一，折叠时居中 */
  .icon-container {
    background-color: var(--sidebar-icon-bg);
    will-change: transform;
    transition: transform 150ms ease, border-color 150ms ease;
    cursor: pointer;
    border: 2px solid transparent;
  }

  /* 折叠状态下：导航项整体居中，和Logo对齐 */
  html[data-sidebar-open="false"] #sidebar .nav-link {
    flex-direction: column;
    align-items: center;
    padding: 0.25rem;
    width: auto;
    background: transparent;
    box-shadow: none;
  }
  html[data-sidebar-open="false"] #sidebar .nav-link span {
    margin-top: 0.5rem;
    margin-left: 0;
    font-size: 0.75rem;
    text-align: center;
  }

  /* 折叠状态隐藏外链指示，避免跑到文字右下角 */
  .external-indicator { flex-shrink: 0; }
  html[data-sidebar-open="false"] #sidebar .external-indicator { display: none; }

  /* 展开状态下：导航项横向排列 */
  html[data-sidebar-open="true"] #sidebar .nav-link {
    width: 100%;
  }

  /* 复用hover高亮逻辑 */
  .nav-link:hover {
    background-color: var(--theme-color-light);
  }

  .nav-link:hover .icon,
  .nav-link:hover span {
    color: var(--theme-color);
  }

  html[data-sidebar-open="false"] #sidebar .nav-link:hover {
    background-color: transparent;
  }
  html[data-sidebar-open="false"] #sidebar .nav-link:hover .icon-container {
    border-color: var(--theme-color);
  }

  .nav-link.is-active .icon-container {
    transform: scale(1.06);
    border-color: var(--theme-color);
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.08), 0 2px 4px -2px rgb(0 0 0 / 0.06);
  }

  .icon, .bottom-bar-icon {
    color: var(--sidebar-icon-symbol);
    transition: color 0.3s ease;
  }

  /* 搜索框样式优化 */
  input::placeholder {
    color: var(--text-secondary);
    opacity: 0.7;
  }

  /* 导航链接基础样式 */
  .nav-link {
    text-decoration: none !important;
    color: inherit;
    cursor: pointer;
  }

  .nav-link:hover,
  .nav-link:focus {
    text-decoration: none !important;
    outline: none;
  }

  #sidebar nav::-webkit-scrollbar {
    display: none;
  }
  #sidebar nav { scrollbar-gutter: stable; min-height: 0; padding-bottom: var(--bottom-bar-height); }
  #sidebar aside { position: absolute; bottom: 0; left: 0; right: 0; height: var(--bottom-bar-height); background-color: var(--sidebar-bg); }
  #sidebar aside * { transition: none !important; }

  .bottom-bar { display: flex; padding: 0.25rem; gap: 0.5rem; }
  .bottom-bar .nav-link { padding: 0.25rem; }
  .bottom-bar-icon { border: 2px solid transparent; }
  .bottom-bar .nav-link:hover .bottom-bar-icon { border-color: var(--theme-color); }
  html[data-sidebar-open="false"] #sidebar .bottom-bar { flex-direction: column; align-items: center; justify-content: center; }
  html[data-sidebar-open="true"] #sidebar .bottom-bar { flex-direction: column; align-items: center; justify-content: flex-start; }
  #sidebar {
    --sidebar-width: 4rem; /* 折叠宽度 */
    --sidebar-width-wide: 14rem; /* 展开宽度 */
    --bottom-bar-height-collapsed: 10rem; /* 底部栏折叠高度 (3个图标 + 间距) */
    --bottom-bar-height-expanded: 10rem; /* 底部栏展开高度 */
  }
  #sidebar { --bottom-bar-height: var(--bottom-bar-height-collapsed); }
  html[data-sidebar-open="true"] #sidebar { --bottom-bar-height: var(--bottom-bar-height-expanded); }

  /* 底部栏文字控制 */
  /* 折叠时隐藏文字，仅显示图标 */
  html[data-sidebar-open="false"] #sidebar .bottom-bar .sidebar-text { 
    /* 使用通用的 .sidebar-text 规则控制，这里不需要额外隐藏，
       因为上面的 .sidebar-text 默认 opacity: 0 */
  }
</style>

<script>
  function setSidebarOpen(next: boolean) {
    const root = document.documentElement;
    const sidebar = document.getElementById('sidebar');
    root.classList.remove('no-sidebar-transition');
    const end = () => {
      root.classList.add('no-sidebar-transition');
      if (sidebar) sidebar.removeEventListener('transitionend', end);
    };
    if (sidebar) sidebar.addEventListener('transitionend', end);
    setTimeout(end, 400);
    root.setAttribute('data-sidebar-open', next ? 'true' : 'false');
    if (sidebar) sidebar.dataset.open = next ? '1' : '0';
    try { localStorage.setItem('sidebarOpen', next.toString()); } catch {}
    try { document.cookie = `sidebarOpen=${next}; path=/; max-age=31536000`; } catch {}
  }

  function bindDelegates() {
    if ((window as any).__sidebarBound) return;
    document.addEventListener('click', (e) => {
      const t = e.target as Element | null;
      if (!t) return;
      const toggle = t.closest('#sidebar-toggle');
      if (toggle) {
        const current = document.documentElement.getAttribute('data-sidebar-open') === 'true';
        setSidebarOpen(!current);
        return;
      }
      const openSearch = t.closest('#open-search-btn');
      if (openSearch) {
        window.dispatchEvent(new CustomEvent('search:open'));
        return;
      }
    });
    (window as any).__sidebarBound = true;
  }

  function initSidebar() {
    const sidebar = document.getElementById('sidebar');
    if (!sidebar) return;

    // 更新侧边栏链接的激活状态（因为 Sidebar 是持久化的，切换页面不会重新渲染）
    const updateActiveLinks = () => {
      const currentPath = window.location.pathname;
      // 移除末尾斜杠以统一比较（除非是根路径）
      const normalize = (p: string) => p.length > 1 && p.endsWith('/') ? p.slice(0, -1) : p;
      const normCurrent = normalize(currentPath);

      const links = sidebar.querySelectorAll('a.nav-link');
      links.forEach(link => {
        const href = link.getAttribute('href');
        if (!href) return;
        
        const linkPath = new URL(href, window.location.origin).pathname;
        const normLink = normalize(linkPath);

        let isActive = false;
        if (normLink === '/') {
          isActive = normCurrent === '/';
        } else {
          isActive = normCurrent.startsWith(normLink);
        }

        if (isActive) {
          link.classList.add('is-active');
        } else {
          link.classList.remove('is-active');
        }
      });
    };
    updateActiveLinks();

    if ((window as any).__sidebarInitBound) return;
    (window as any).__sidebarInitBound = true;

    try {
      const savedState = localStorage.getItem('sidebarOpen');
      if (savedState === 'true' || savedState === 'false') {
        document.cookie = `sidebarOpen=${savedState}; path=/; max-age=31536000`;
        sidebar.dataset.open = savedState === 'true' ? '1' : '0';
      } else {
        sidebar.dataset.open = (document.documentElement.getAttribute('data-sidebar-open') === 'true') ? '1' : '0';
      }
    } catch {
      sidebar.dataset.open = (document.documentElement.getAttribute('data-sidebar-open') === 'true') ? '1' : '0';
    }

    bindDelegates();

    try {
      const label = document.getElementById('theme-mode-label');
      const update = () => {
        if (!label) return;
        const isDark = document.documentElement.classList.contains('dark');
        label.textContent = isDark ? '深色' : '浅色';
      };
      update();
      const mo = new MutationObserver(update);
      mo.observe(document.documentElement, { attributes: true, attributeFilter: ['class','data-theme'] });
      window.addEventListener('storage', update);
      document.addEventListener('astro:after-swap', update);
    } catch {}

    try {
      const item = document.getElementById('theme-mode-item');
      if (item) {
        item.addEventListener('click', (e) => {
          const target = e.target as Element | null;
          if (target && target.closest('.icon-container button')) return;
          const w = window as any;
          if (typeof w.__toggleTheme === 'function') {
            e.stopPropagation();
            w.__toggleTheme(e);
            if (w.__themeStore && typeof w.__themeStore.update === 'function') {
              w.__themeStore.update((cur: 'light'|'dark') => cur === 'light' ? 'dark' : 'light');
            }
          } else {
            const c = item.querySelector('.icon-container');
            const btn = c ? (c.querySelector('button') as HTMLElement | null) : null;
            if (btn) {
              btn.dispatchEvent(new MouseEvent('click', { bubbles: true, clientX: (e as MouseEvent).clientX, clientY: (e as MouseEvent).clientY }));
            }
          }
        });
      }
    } catch {}

    try {
      const item = document.getElementById('theme-color-item');
      if (item) {
        item.addEventListener('click', (e) => {
          const target = e.target as Element | null;
          if (target && target.closest('.icon-container button')) return;
          e.stopPropagation();
          e.preventDefault();
          const btn = item.querySelector('.icon-container button') as HTMLElement | null;
          if (btn) btn.dispatchEvent(new MouseEvent('click', { bubbles: true }));
        });
      }
    } catch {}
  }

  (window as any).__initSidebar = initSidebar;
  initSidebar();
</script>
