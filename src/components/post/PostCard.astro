---
import type { CollectionEntry } from "astro:content";
import { render } from "astro:content";
import { Icon } from 'astro-icon/components';
import { formatFullDate } from '../../utils/date-utils';

interface Props {
  class?: string;
  entry: CollectionEntry<"posts">;
  style?: string;
}

const { entry, style } = Astro.props;
const className = Astro.props.class;

const { title, description, categories, tags, date, cover, pinned, slug } = entry.data;
const { remarkPluginFrontmatter } = await render(entry);
const url = `/posts/${slug}/`;
const { wordCount, readingTime } = remarkPluginFrontmatter;
const minutes = Math.ceil(readingTime) || 1;

// 封面判断：仅有效http链接视为有封面
const hasCover = typeof cover === 'string' && (cover as string).trim().startsWith('http');
const firstCategory = categories && categories.length > 0 ? categories[0] : '文章';
---

<article class:list={[
  "w-full group overflow-hidden rounded-lg bg-[var(--content-pane-bg)] shadow-sm hover:shadow-lg",
  "transform hover:-translate-y-1 transition-transform duration-300",
  className
]} style={`${style || ''} contain: paint;`}>
  
  <!-- 核心修改：小屏幕垂直排列（flex-col），大屏幕水平排列（md:flex-row） -->
  <div class="w-full flex flex-col md:flex-row h-full min-w-0">
    {/* 封面区域：大屏幕占1/3宽度，flex-shrink-0避免被压缩 */}
    {hasCover && (
      <div class="w-full md:w-2/5 flex-shrink-0 px-2 py-3 md:px-3 md:pt-6 md:pb-6">
        <a 
          href={url} 
          class="block relative overflow-hidden rounded-lg shadow-inner h-full border border-[var(--line-divider)]"
          transition:name={`hero-${slug}`}
        >
          <div class="pt-[56.25%] bg-[var(--content-pane-bg)]"></div>
          <img 
            src={cover} 
            alt={title || "文章封面"} 
            class="absolute top-0 left-0 w-full h-full object-cover transition-transform duration-700 ease-in-out group-hover:scale-110"
            loading="lazy"
            onerror="this.onerror=null; this.src='/assets/blog-placeholder-1.jpg';"
          />
        </a>
      </div>
    )}

    <!-- 内容区域：大屏幕占2/3宽度，和封面并排 -->
    <div class:list={[
      "w-full flex flex-col px-3 py-4 md:p-5 min-w-0",
      hasCover ? "md:w-3/5" : "md:w-full",
      hasCover ? "md:pt-6 md:pb-6" : ""
    ]}>
      <div class="flex items-start justify-between mb-3">
        <h3 class="post-card-title flex-grow text-xl md:text-2xl font-bold">
          <a
            href={url}
            class="break-all"
            style="line-break: anywhere; overflow-wrap: anywhere; view-transition-name: none;"
          >
            {title}
          </a>
        </h3>
        {pinned && (
          <div class="ml-4 flex-shrink-0 bg-red-500 text-white px-2 py-1 rounded text-xs font-medium
            transition-transform duration-300 group-hover:scale-105">
            置顶
          </div>
        )}
      </div>

      <div class="flex flex-col gap-y-2 text-xs md:text-sm text-secondary mb-4">
        <div class="flex flex-wrap items-center gap-x-2 md:gap-x-4 gap-y-1">
          <div class="inline-flex items-center gap-1.5">
            <Icon name="material-symbols:calendar-month-outline" class="h-4 w-4 md:h-5 md:w-5 flex-shrink-0" />
            <span>{formatFullDate(new Date(date))}</span>
          </div>
          <div class="inline-flex items-center gap-1.5">
            <Icon name="material-symbols:timer-outline" class="h-4 w-4 md:h-5 md:w-5 flex-shrink-0" />
            <span>{minutes} 分钟阅读</span>
          </div>
          <div class="inline-flex items-center gap-1.5">
            <Icon name="material-symbols:summarize-outline" class="h-4 w-4 md:h-5 md:w-5 flex-shrink-0" />
            <span>约 {wordCount.toLocaleString()} 字</span>
          </div>
        </div>
      </div>

      <p class="text-secondary dark:text-gray-400 text-xs md:text-sm mb-4 line-clamp-2 leading-relaxed">
        {description || "暂无描述..."}
      </p>

      <!-- 底部区域：分类标签 + 阅读全文 -->
      <div class="mt-auto flex items-end gap-2">
        <div class="flex flex-wrap items-center gap-3 flex-1 min-w-0">
          {categories && categories.length > 0 && (
            <a
              href={`/archive/?分类=${categories.map((c) => encodeURIComponent(c)).join('/')}`}
              class="inline-flex items-center gap-0.5 md:gap-1 px-2 py-0.5 md:px-3 md:py-1 rounded-full category-container"
              style="
                background: color-mix(in srgb, var(--theme-color) 12%, transparent);
                color: var(--theme-color);
                border: 1px solid color-mix(in srgb, var(--theme-color) 35%, transparent);
              "
              aria-label={`查看分类：${categories.join(' / ')}`}
            >
              <Icon name="material-symbols:folder-open-outline" class="h-3 w-3 md:h-4 md:w-4 flex-shrink-0" />
              <span class="text-xs font-medium">{categories.join(' / ')}</span>
            </a>
          )}
      
          {tags && tags.length > 0 && (
            <div
              class="inline-flex items-center gap-0.5 md:gap-1 px-2 py-0.5 md:px-3 md:py-1 rounded-full tag-container"
              style="
                background: color-mix(in srgb, var(--theme-color) 10%, transparent);
                color: var(--theme-color);
                border: 1px solid color-mix(in srgb, var(--theme-color) 30%, transparent);
              "
            >
              <Icon name="material-symbols:label-outline" class="h-3 w-3 md:h-4 md:w-4 flex-shrink-0" />
              <span class="text-xs font-medium tag-list">
                {tags.map((tag) => (
                  <a
                    href={`/archive/?标签=${encodeURIComponent(tag)}`}
                    class="hover:underline"
                    aria-label={`查看标签：${tag}`}
                  >{tag}</a>
                ))}
              </span>
            </div>
          )}
        </div>
      
        <a href={url} class="ml-auto self-end group text-sm font-semibold text-blue-600 dark:text-blue-400 flex items-center gap-1
          hover:text-blue-700 dark:hover:text-blue-300 transition-colors duration-300">
          <span>阅读全文</span>
          <Icon name="material-symbols:arrow-right-alt" class="h-5 w-5 transition-transform duration-300 group-hover:translate-x-1" />
        </a>
      </div>
    </div>
  </div>
</article>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .category-container:hover,
  .tag-container:hover {
    transform: scale(1.03);
    transition: transform 0.2s ease;
  }

  .tag-container .tag-list {
    display: inline-flex;
    align-items: baseline;
    gap: 0;
    flex-wrap: wrap;
    white-space: normal;
    overflow-wrap: anywhere;
  }
  .tag-container .tag-list a + a::before {
    content: "/";
    opacity: 0.7;
    margin: 0;
  }
  .tag-container .tag-list span,
  .tag-container .tag-list a,
  .tag-container .tag-list .sep {
    font-size: 0.75rem;
    line-height: 1rem;
  }
  .tag-container .tag-list .sep {
    margin: 0;
  }

  .category-container,
  .tag-container {
    max-width: 100%;
    flex-wrap: wrap;
  }
  .category-container span {
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
  }

  /* 标题颜色：浅色黑、深色白，强制覆盖全局链接色 */
  .post-card-title a { color: var(--text-primary) !important; }
</style>