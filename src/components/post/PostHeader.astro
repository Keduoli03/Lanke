---
import { formatDateToYYYYMMDD } from '@/utils/date-utils';
import { Icon } from 'astro-icon/components';
import type { CollectionEntry } from 'astro:content';
import { render } from 'astro:content';

interface Props {
  post: CollectionEntry<'posts'>;
}

const { post } = Astro.props;
const { title, date, updated, categories, tags, pinned } = post.data;
const { remarkPluginFrontmatter } = await render(post);
const { wordCount, readingTime } = remarkPluginFrontmatter || { wordCount: 0, readingTime: 0 };
const minutes = Math.ceil(readingTime) || 0;
---
<header class="mb-8 post-header">
  <h1 class="text-2xl font-bold mb-4 text-primary md:text-4xl">{title}</h1>
  <div class="text-secondary mb-6 flex flex-wrap items-center gap-x-4 gap-y-2 text-sm meta">
    <div class="flex items-center gap-x-1.5">
      <Icon name="material-symbols:calendar-today-outline-rounded" class="w-4 h-4" />
      <span>发布于 {formatDateToYYYYMMDD(date)}</span>
    </div>
    {updated && (
      <div class="flex items-center gap-x-1.5">
        <Icon name="material-symbols:update-rounded" class="w-4 h-4" />
        <span>更新于 {formatDateToYYYYMMDD(updated)}</span>
      </div>
    )}
    
    {wordCount > 0 && (
      <div class="flex items-center gap-x-1.5">
        <Icon name="material-symbols:description-outline-rounded" class="w-4 h-4" />
        <span>约 {wordCount.toLocaleString()} 字</span>
      </div>
    )}
    {minutes > 0 && (
      <div class="flex items-center gap-x-1.5">
        <Icon name="material-symbols:timer-outline" class="h-4 w-4 flex-shrink-0" />
        <span>{minutes} 分钟阅读</span>
      </div>
    )}
    {pinned && (
      <div class="flex items-center text-sm text-secondary">
        <Icon name="material-symbols:push-pin" class="h-4 w-4 flex-shrink-0" />
        <span class="ml-1">置顶</span>
      </div>
    )}
  </div>
  
  <div class="flex flex-wrap gap-3 mb-6 badges">
    {categories && categories.map((category, index) => (
      <a 
        href={`/archive/?分类=${encodeURIComponent(category)}`}
        class="category-badge"
        transition:name={index === 0 ? `category-${post.data.slug}` : ''}
      >
        <Icon name="material-symbols:folder-open-outline" class="w-4 h-4" />
        {category}
      </a>
    ))}
    {tags && tags.map(tag => (
      <a href={`/archive/?标签=${encodeURIComponent(tag)}`} class="tag-badge">
        #{tag}
      </a>
    ))}
  </div>
</header>

<style>
  .category-badge, .tag-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.875rem;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    transition: all 0.2s ease-in-out;
    border: 1px solid transparent;
  }

  .category-badge {
    background-color: hsl(var(--primary-hue), 80%, 92%);
    color: hsl(var(--primary-hue), 60%, 35%);
  }
  .category-badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px -1px hsl(var(--primary-hue) 50% 50% / 0.2);
  }
  html.dark .category-badge {
    background-color: hsl(var(--primary-hue), 40%, 25%);
    color: hsl(var(--primary-hue), 60%, 85%);
  }

  .tag-badge {
    background-color: var(--tag-bg);
    color: var(--text-secondary);
  }
  .tag-badge:hover {
    color: var(--text-primary);
    background-color: hsl(var(--primary-hue), 20%, 88%);
  }
  html.dark .tag-badge:hover {
    background-color: hsl(var(--primary-hue), 15%, 35%);
  }

  .pinned-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.875rem;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    background-color: hsl(50, 100%, 90%);
    color: hsl(50, 70%, 30%);
    font-weight: 500;
  }
  html.dark .pinned-badge {
    background-color: hsl(50, 40%, 20%);
    color: hsl(50, 90%, 80%);
  }

  /* 手机端优化：仅在没有封面图（PostHeader是首个元素）时，收紧标题与顶部的距离 */
  @media (max-width: 640px) {
    .post-header {
      margin-top: 0;
    }

    .post-header:first-child {
      margin-top: -0.75rem; /* 轻微上移，抵消容器的上内边距 */
    }

    .post-header h1 {
      font-size: 1.25rem;  /* 原 text-2xl ≈ 1.5rem，下调 */
      line-height: 1.3;
      margin-bottom: 0.4rem; /* 再稍微缩小下间距 */
    }

    .post-header .meta {
      font-size: 0.78rem;       /* 发布/更新等信息整体再缩小一点 */
      gap: 0.2rem 0.4rem;       /* 横纵向间距进一步收紧，尽量压一行 */
      margin-bottom: 0.45rem;   /* 与下方更紧凑 */
    }

    .post-header .badges {
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .post-header .category-badge,
    .post-header .tag-badge {
      font-size: 0.78rem;
      padding: 0.18rem 0.55rem;
      gap: 0.28rem;
    }
  }
</style>
