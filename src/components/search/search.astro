---
import MainLayout from '@/layouts/MainLayout.astro';
import { siteConfig } from '@/config';
const title = '搜索';
const description = '站内搜索';
---
<MainLayout title={title} description={description}>
  <div class="search-page">
    <div class="search-bar">
      <input id="search-input" type="text" placeholder="搜索关键词" />
      <button id="search-btn">搜索</button>
    </div>
    <div id="search-status" class="search-status"></div>
    <ul id="search-results" class="results"></ul>
  </div>
  <style>
    .search-page { max-width: var(--page-width); margin: 0 auto; }
    .search-bar { display: flex; gap: .5rem; margin-bottom: 1rem; }
    #search-input { flex: 1; padding: .5rem .75rem; border: 1px solid var(--line-divider); border-radius: .5rem; background: var(--content-pane-bg); color: var(--text-primary); }
    #search-btn { padding: .5rem .9rem; border-radius: .5rem; border: 1px solid var(--line-divider); background: var(--tag-bg); color: var(--text-primary); }
    .results { list-style: none; padding: 0; margin: 0; display: grid; gap: .75rem; }
    .result-item { border: 1px solid var(--line-divider); border-radius: .75rem; padding: .75rem .9rem; background: var(--content-pane-bg); }
    .result-title { font-weight: 600; color: var(--text-primary); }
    .result-excerpt { font-size: .9rem; color: var(--text-secondary); margin-top: .3rem; }
    .search-status { color: var(--text-secondary); font-size: .9rem; margin-bottom: .5rem; }
    mark { background: color-mix(in srgb, var(--theme-color) 25%, transparent); color: var(--text-primary); }
  </style>
  <script>
    const ensurePagefind = (async () => {
      try {
        const mod = await (new Function('return import("/pagefind/pagefind.js")'))();
        return mod;
      } catch (e) {
        return null;
      }
    });
    const runSearch =  (async () => {
      const status = document.getElementById('search-status');
      const list = document.getElementById('search-results');
      const inputEl = document.getElementById('search-input');
      if (!(status instanceof HTMLElement) || !(list instanceof HTMLElement)) return;
      const q = (inputEl instanceof HTMLInputElement) ? inputEl.value.trim() : '';
      list.innerHTML = '';
      status.textContent = '搜索中...';
      const pf = await ensurePagefind();
      if (!pf) { status.textContent = '索引未就绪，请先构建站点'; return; }
      const res = await pf.search(q || '');
      status.textContent = `共 ${res.results.length} 条结果`;
      for (const r of res.results.slice(0, 50)) {
        const data = await r.data();
        const li = document.createElement('li');
        li.className = 'result-item';
        li.innerHTML = `
          <a class=\"result-title\" href=\"${data.url}\">${data.meta?.title || data.url}</a>
          <div class=\"result-excerpt\">${data.excerpt || ''}</div>
        `;
        list.appendChild(li);
      }
    });
    const inputEl = document.getElementById('search-input');
    const btnEl = document.getElementById('search-btn');
    if (!(inputEl instanceof HTMLInputElement) || !(btnEl instanceof HTMLElement)) return;
    const params = new URLSearchParams(location.search);
    const initial = params.get('q') || '';
    inputEl.value = initial;
    /** @type {number} */ let t = 0;
    inputEl.addEventListener('input', () => { clearTimeout(t); t = window.setTimeout(() => runSearch(), 200); });
    inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') { runSearch(); } });
    btnEl.addEventListener('click', () => runSearch());
    runSearch();
  </script>
</MainLayout>