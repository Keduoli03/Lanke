---
import { getAllTags } from '../../utils/content-utils';
import { Icon } from 'astro-icon/components';

interface Props {
  class?: string;
}

const { class: className } = Astro.props;
let tags = await getAllTags();

// 按标签数量从多到少排序
tags = tags.sort((a, b) => b.count - a.count);

---

<div class:list={["tag-cloud-container", className]}>
  <div class="widget-header">
    <div class="widget-header-left">
      <Icon name="material-symbols:label-outline" class="widget-icon" />
      <h3 class="widget-title">标签云</h3>
    </div>
    <div class="widget-header-right">
      <span class="widget-count">{tags.length}</span>
      <!-- 折叠/展开按钮 -->
      <button class="expand-btn" data-expanded="true">
        <Icon name="material-symbols:expand-more" class="expand-icon" />
      </button>
    </div>
  </div>
  
  <!-- 标签列表（默认展开） -->
  <div class="tag-cloud" data-expanded="true">
    {tags.map(tag => (
      <a 
        href={`/tags/${encodeURIComponent(tag.name)}/`}
        class="tag-item"
        title={`${tag.name} (${tag.count} 篇文章)`}
        key={tag.name}
      >
        <span class="tag-hash">#</span>
        <span class="tag-name">{tag.name}</span>
        <span class="tag-count">{tag.count}</span>
      </a>
    ))}
  </div>
</div>

<script>
  // 折叠/展开功能实现
  document.addEventListener('astro:page-load', () => {
    const expandBtn = document.querySelector('.expand-btn');
    const tagCloud = document.querySelector('.tag-cloud');
    const expandIcon = document.querySelector('.expand-icon');
    
    if (expandBtn && tagCloud && expandIcon) {
      // 初始化状态（默认展开）
      const updateUI = (isExpanded: boolean) => {
        tagCloud.setAttribute('data-expanded', isExpanded.toString());
        expandBtn.setAttribute('data-expanded', isExpanded.toString());
        expandIcon.style.transform = isExpanded ? 'rotate(180deg)' : 'rotate(0deg)';
        tagCloud.style.display = isExpanded ? 'flex' : 'none';
      };
      
      // 初始渲染
      updateUI(expandBtn.getAttribute('data-expanded') === 'true');
      
      // 点击事件
      expandBtn.addEventListener('click', () => {
        const isExpanded = expandBtn.getAttribute('data-expanded') === 'true';
        updateUI(!isExpanded);
      });
    }
  });
</script>

<style>
  .tag-cloud-container {
    background: var(--content-pane-bg);
    border-radius: 0.875rem;
    padding: 1.5rem;
    box-shadow: 0 2px 8px 0 rgb(0 0 0 / 0.1);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
  }
  
  .widget-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem; 
    margin-bottom: 1.25rem;
    padding-bottom: 0.875rem;
    border-bottom: 1px solid var(--border-color);
  }

  .widget-header-left {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .widget-header-right {
    display: flex;
    align-items: center;
    gap: 0.5rem; 
  }
  
  .widget-icon {
    width: 1.25rem;
    height: 1.25rem;
    color: var(--text-primary);
    flex-shrink: 0;
  }
  
  .widget-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
    letter-spacing: -0.025em;
  }
  
  .widget-count { 
    background: var(--tag-bg); 
    color: var(--text-secondary);
    font-size: 0.75rem; 
    padding: 0.25rem 0.6rem;
    border-radius: 9999px; 
    font-weight: 600; 
    transition: all 0.3s ease; 
  } 

  /* 折叠/展开按钮样式 */
  .expand-btn {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .expand-btn:hover { 
    color: var(--theme-color); 
    background: var(--sidebar-icon-bg);
    box-shadow: 0 0 12px 0 color-mix(in srgb, var(--theme-color) 40%, transparent);
  } 
  
  .expand-icon {
    width: 1.25rem;
    height: 1.25rem;
    transition: transform 0.3s ease;
  }

  /* 标签列表样式（默认展开） */
  .tag-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 0.3rem;
    justify-content: flex-start;
    padding-top: 0.5rem;
    transition: all 0.3s ease;
  }

  /* 折叠状态隐藏 */
  .tag-cloud[data-expanded="false"] {
    display: none;
  }

  /* 基础标签样式 */
  .tag-cloud-container .tag-item {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    background: var(--tag-bg);
    color: var(--text-secondary);
    padding: 0.25rem 0.6rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    text-decoration: none;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .tag-cloud-container .tag-item .tag-hash {
    color: var(--theme-color);
    font-weight: 600;
    transition: all 0.25s ease;
    flex: 0 0 auto;
  }

  .tag-cloud-container .tag-item .tag-name {
    color: var(--text-primary);
    transition: color 0.25s ease;
    flex: 1 1 auto;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* 标签计数样式 */
  .tag-count {
    background: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 0.7em;
    padding: 0.15rem 0.35rem;
    border-radius: 9999px;
    font-weight: 600;
    min-width: 1rem;
    text-align: center;
    transition: all 0.3s ease;
  }
  
  /* 悬浮效果 */
  .tag-cloud-container .tag-item:hover {
    transform: translateY(-2px) scale(1.02);
    background: linear-gradient(135deg, var(--theme-color), var(--theme-color-secondary, var(--theme-color)));
    color: white;
    box-shadow: 0 6px 20px -6px rgba(var(--theme-color-rgb, 59, 130, 246), 0.4);
    border-color: transparent;
  }

  .tag-cloud-container .tag-item:hover .tag-hash,
  .tag-cloud-container .tag-item:hover .tag-name,
  .tag-cloud-container .tag-item:hover .tag-count {
    color: white;
  }
  
  .tag-cloud-container .tag-item:hover .tag-hash {
    transform: rotate(15deg) scale(1.1);
  }

  .tag-cloud-container .tag-item:hover .tag-count {
    transform: scale(1.05);
    background: rgba(255, 255, 255, 0.25);
  }

  /* 深色模式适配 */
  html.dark .tag-cloud-container .tag-item {
    background: var(--dark-tag-bg, var(--tag-bg));
    border-color: var(--dark-border-color, var(--border-color));
  }

  html.dark .tag-cloud-container .tag-item:hover {
    background: linear-gradient(135deg, rgba(var(--theme-color-rgb), 0.6), rgba(var(--theme-color-rgb), 0.4));
    color: var(--text-primary);
    box-shadow: 0 4px 15px -4px rgba(var(--theme-color-rgb), 0.3);
    border-color: rgba(var(--theme-color-rgb), 0.5);
  }

  html.dark .tag-cloud-container .tag-item:hover .tag-hash {
    color: var(--theme-color);
  }

  html.dark .tag-cloud-container .tag-item:hover .tag-name {
    color: var(--text-primary);
  }

  html.dark .tag-cloud-container .tag-item:hover .tag-count {
    background: rgba(0, 0, 0, 0.25);
    color: var(--text-secondary);
  }
  
  /* 响应式调整 */
  @media (max-width: 768px) {
    .tag-cloud-container {
      padding: 1rem;
    }
    
    .tag-cloud {
      gap: 0.25rem;
    }
    
    .tag-cloud-container .tag-item {
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
    }
  }
</style>