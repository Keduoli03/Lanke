---
import { getAllCategories, getAllTags } from '../../utils/content-utils';
import { Icon } from 'astro-icon/components';

interface Props {
  class?: string;
  defaultExpanded?: boolean;
}

const { class: className, defaultExpanded = false } = Astro.props;
const categories = await getAllCategories();
const tags = await getAllTags();
---

<!-- 容器完全复制目录的 toc-container 样式，宽度100%填满父容器 -->
<div class:list={[
  "category-filter-container sticky top-6 p-4 bg-content-pane dark:bg-content-pane rounded-lg border border-border shadow-sm",
  className
]} data-expanded={defaultExpanded} style="width: 100%;">
  <div class="combined-content" data-expanded="true">
    <!-- 分类 section：完全对齐目录标题样式 -->
    <div class="section">
      <h4 class="section-title flex items-center gap-3 mb-5 pb-3 border-b border-border">
        <div class="flex items-center justify-center w-7 h-7 rounded-full bg-theme/10">
          <Icon name="material-symbols:folder-outline" class="h-5 w-5 text-theme" />
        </div>
        <span class="text-lg font-bold text-primary">分类</span>
        <button class="filters-reset ml-auto" type="button" aria-label="重置筛选" title="重置筛选">
          <Icon name="material-symbols:restart-alt" class="h-5 w-5" />
        </button>
      </h4>
      <!-- 分类列表：间距与目录一致 -->
      <div class="filter-list flex flex-wrap gap-1.5">
        {categories.map(category => (
          <a
            href="#"
            class="filter-item"
            data-filter-type="category"
            data-filter-value={category.name}
            data-no-transition="true"
            title={`筛选分类：${category.name}`}
          >
            <span class="item-name">{category.name}</span>
          </a>
        ))}
      </div>
    </div>

    <!-- 标签 section：与分类样式统一，间距对齐目录 -->
    <div class="section mt-5">
      <h4 class="section-title flex items-center gap-3 mb-5 pb-3 border-b border-border">
        <div class="flex items-center justify-center w-7 h-7 rounded-full bg-theme/10">
          <Icon name="material-symbols:label-outline" class="h-5 w-5 text-theme" />
        </div>
        <span class="text-lg font-bold text-primary">标签</span>
      </h4>
      <!-- 标签列表：与分类列表样式统一 -->
      <div class="filter-list flex flex-wrap gap-1.5">
        {tags.map(tag => (
          <a
            href="#"
            class="filter-item"
            data-filter-type="tag"
            data-filter-value={tag.name}
            data-no-transition="true"
            title={`筛选标签：${tag.name}`}
          >
            <span class="item-name">{tag.name}</span>
          </a>
        ))}
      </div>
    </div>
  </div>
</div>


<script>
  document.addEventListener('astro:page-load', () => {
    const items: HTMLElement[] = Array.from(
      document.querySelectorAll<HTMLElement>('.category-filter-container .filter-item')
    );

    const getSelectedFromURL = (): { categories: string[]; tags: string[] } => {
      const params = new URLSearchParams(window.location.search);
      const singleCat = params.get('分类') || '';
      const cats = singleCat ? [singleCat] : [];
      const tags = params.getAll('标签'); // 标签多值
      return { categories: cats, tags };
    };

    const updateItemTitle = (el: HTMLElement): void => {
      const type = el.getAttribute('data-filter-type');
      const value = el.getAttribute('data-filter-value') || '';
      const isActive = el.classList.contains('active');
      const prefix =
        type === 'category'
          ? (isActive ? '已选分类：' : '筛选分类：')
          : (isActive ? '已选标签：' : '筛选标签：');
      el.setAttribute('title', `${prefix}${value}`);
    };

    const applySelectionFromURL = (): void => {
      const { categories, tags } = getSelectedFromURL();
      const singleCategory = categories[0] || '';
      items.forEach((el: HTMLElement) => {
        const type = el.getAttribute('data-filter-type');
        const value = el.getAttribute('data-filter-value') || '';
        const shouldActive =
          (type === 'category' && value === singleCategory) ||
          (type === 'tag' && tags.includes(value));
        el.classList.toggle('active', shouldActive);
        updateItemTitle(el);
      });
      window.dispatchEvent(new CustomEvent('filters:changed', { detail: { categories, tags } }));
    };

    const getSelected = (): { categories: string[]; tags: string[] } => {
      const selectedCategories = Array.from(
        document.querySelectorAll<HTMLElement>('.category-filter-container .filter-item[data-filter-type="category"].active')
      ).map(n => n.getAttribute('data-filter-value') || '').filter(Boolean);
      const singleCategory = selectedCategories[0] ? [selectedCategories[0]] : [];
      const selectedTags = Array.from(
        document.querySelectorAll<HTMLElement>('.category-filter-container .filter-item[data-filter-type="tag"].active')
      ).map(n => n.getAttribute('data-filter-value') || '').filter(Boolean);
      return { categories: singleCategory, tags: selectedTags };
    };

    const updateURL = (categories: string[], tags: string[]): void => {
      const url = new URL(window.location.href);
      // 分类单值
      url.searchParams.delete('分类');
      if (categories[0]) url.searchParams.set('分类', categories[0]);
      // 标签多值
      url.searchParams.delete('标签');
      tags.forEach((t: string) => url.searchParams.append('标签', t));
      window.history.replaceState(null, '', url);
    };

    // 初始根据 URL 恢复选中并触发筛选
    applySelectionFromURL();

    // 点击交互：分类单选（可取消），标签多选；更新 title、URL、分发事件
    items.forEach((el: HTMLElement) => {
      el.addEventListener('click', (e: MouseEvent) => {
        e.preventDefault();
        const type = el.getAttribute('data-filter-type');

        if (type === 'category') {
          const isActive = el.classList.contains('active');
          // 清空其他分类
          document
            .querySelectorAll<HTMLElement>('.category-filter-container .filter-item[data-filter-type="category"].active')
            .forEach(n => n.classList.remove('active'));
          // 切换当前：未选中则选中；已选中则清空（实现单选+可取消）
          el.classList.toggle('active', !isActive);
          // 更新所有分类项的 title
          document
            .querySelectorAll<HTMLElement>('.category-filter-container .filter-item[data-filter-type="category"]')
            .forEach(n => updateItemTitle(n));
        } else {
          // 标签维持多选切换
          el.classList.toggle('active');
          updateItemTitle(el);
        }

        const { categories, tags } = getSelected();
        updateURL(categories, tags);
        window.dispatchEvent(new CustomEvent('filters:changed', { detail: { categories, tags } }));
      });
    });

    // 监听浏览器返回/前进，自动同步选中与筛选
    window.addEventListener('popstate', applySelectionFromURL);

    const resetBtn = document.querySelector<HTMLButtonElement>('.filters-reset');
    resetBtn && resetBtn.addEventListener('click', () => {
      const url = new URL(window.location.href);
      url.searchParams.delete('分类');
      url.searchParams.delete('标签'); // 清空所有同名标签参数
      window.history.replaceState(null, '', url);

      // 根据 URL 重新同步选中，并分发 filters:changed
      applySelectionFromURL();

      // 通知时间线按浏览器历史刷新
      window.dispatchEvent(new PopStateEvent('popstate'));
    });
  });
</script>

<style>
  .category-filter-container {
    transition: all 0.2s ease-in-out;
  }

  .section-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 1.25rem 0;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border-color);
  }

  .section-title .Icon {
    width: 1.25rem;
    height: 1.25rem;
    color: var(--theme-color);
  }


  .filter-list {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
  }

  .filter-item {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.2rem 0.3rem;
    border-radius: 0.375rem;
    text-decoration: none;
    transition: all 0.2s ease-in-out;
    color: var(--text-secondary);
    font-size: 0.9rem;
    line-height: 1.3;
    background-color: transparent;
  }

  /* Hover 效果：与目录列表项完全一致 */
  .filter-item:hover {
    color: var(--text-primary);
    background-color: var(--tag-bg);
  }

  /* 激活状态：与目录 active 样式统一 */
  .filter-item.active {
    color: var(--theme-color) !important;
    font-weight: 600;
    background-color: var(--theme-color)/10;
  }

  /* 分类与标签区块间距：对齐目录内部间距 */
  .section + .section {
    margin-top: 1.25rem;
  }

  /* 重置按钮：适配目录风格，不突兀 */
  .filters-reset {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    padding: 0;
    background: transparent;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    color: var(--text-secondary);
    transition: all 0.2s ease;
  }

  .filters-reset:hover {
    background: var(--tag-bg);
    color: var(--theme-color);
  }

  /* 响应式：与目录完全同步 */
  @media (max-width: 640px) {
    .category-filter-container {
      padding: 1rem;
      max-width: none;
    }

    .section-title {
      font-size: 0.9rem;
      gap: 0.5rem;
    }

    .filter-list {
      gap: 0.75rem;
    }

    .filter-item {
      padding: 0.25rem 0.65rem;
      font-size: 0.85rem;
    }
  }

  @media (min-width: 640px) and (max-width: 1023px) {
    .category-filter-container {
      position: static;
      top: auto;
      width: 100%;
      padding: 1rem;
    }
    .section-title { font-size: 0.95rem; }
    .filter-list { gap: 0.5rem; }
    .filter-item { padding: 0.25rem 0.6rem; font-size: 0.85rem; }
  }

  /* 深色模式：与目录一致 */
  html.dark .category-filter-container {
    box-shadow: none;
  }

  html.dark .filter-item.active {
    background-color: var(--theme-color)/20;
  }
</style>