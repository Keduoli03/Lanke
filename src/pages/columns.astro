---
export const prerender = false;
import PostLayout from '../layouts/PostLayout.astro';
import PageHeader from '@/components/page/PageHeader.astro';
import PostCard from '@/components/post/PostCard.astro';
import { Icon } from 'astro-icon/components';
import { getAllColumns, getPostsByColumn, getSortedPostsWithColumn } from '@/utils/content-utils';
import { getCollection, render } from 'astro:content';
import Markdown from '@/components/util/Markdown/Markdown.astro';

const title = '专栏';
const description = '按专栏浏览文章';

const columns = await getAllColumns();
const selectedParam = (Astro.url.searchParams.get('专栏') || Astro.url.searchParams.get('column') || '').trim();
const selectedColumn = selectedParam || (columns[0]?.name ?? '');
const visiblePosts = selectedColumn
  ? await getPostsByColumn(selectedColumn)
  : await getSortedPostsWithColumn();

const pages = await getCollection('pages');
const slugCandidates = [
  `columns/${selectedColumn}`,
  `columns-${selectedColumn}`,
  `columns_${selectedColumn}`,
  `${selectedColumn}`,
];
const descEntry = pages.find(p => slugCandidates.includes(p.data.slug));
let ColumnContent: any = null;
if (descEntry) {
  const rendered = await render(descEntry);
  ColumnContent = rendered.Content;
}
---

<PostLayout title={title} description={description}>
  <div class="columns-container">
    <PageHeader title={title} subtitle={`${selectedColumn ? `已选：${selectedColumn} · ` : ''}共 ${visiblePosts.length} 篇文章`}>
      <Icon slot="icon" name="material-symbols:view-column-outline" class="w-11 h-11" />
    </PageHeader>

    <div class="columns-row" id="columns-row">
      {columns.map(col => (
        <a
          href={`/columns/?专栏=${encodeURIComponent(col.name)}`}
          class:list={["column-item", { active: selectedColumn === col.name }]}
          data-column={col.name}
          data-no-transition="true"
          title={`筛选专栏：${col.name}`}
        >
          <span class="item-name">{col.name}</span>
          <span class="item-count">{col.count}</span>
        </a>
      ))}
    </div>

    {ColumnContent && (
      <div class="column-desc">
        <Markdown>
          <ColumnContent />
        </Markdown>
      </div>
    )}

    <div class="grid grid-cols-1 gap-6" id="columns-cards">
      {visiblePosts.map(entry => (
        <div class="post-card-wrap" data-column={entry.data.column || ''}>
          <PostCard entry={entry} />
        </div>
      ))}
    </div>
  </div>

  <style is:inline>
    .columns-container { max-width: var(--page-width); margin: 0 1rem; }
    @media (max-width: 768px) { .columns-container { margin: 0; } }

    .column-desc { margin-bottom: 1rem; }

    .columns-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .column-item {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.6rem;
      border-radius: 0.375rem;
      background: var(--tag-bg);
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.2s ease-in-out;
    }
    .column-item.active, .column-item:hover { color: var(--theme-color); }
    .item-count { font-size: 0.75rem; opacity: 0.7; }
    .column-item.all { margin-left: auto; }
  </style>
  
  
  

</PostLayout>
