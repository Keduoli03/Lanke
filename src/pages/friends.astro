---
import Artalk from '@/components/util/Artalk.astro';
import { items as friends } from './page_data/friend.ts';
import Markdown from '@/components/util/Markdown/Markdown.astro';
import { getEntry } from 'astro:content';
import { render } from 'astro:content';
import PageHeader from '@/components/page/PageHeader.astro';
import { Icon } from 'astro-icon/components';
import PostLayout from '@/layouts/PostLayout.astro';
import Toc from '@/components/post/Toc.astro';
import ScrollToTop from '@/components/util/ScrollToTop.astro';
import ScrollToComment from '@/components/util/ScrollToComment.astro';
import fs from 'node:fs';
import '@/styles/cycle.css';

const title = "友链";
const description = "一些朋友们的网站";
const friendPost = await getEntry("pages", "friend");
if (!friendPost) {
  throw new Error('Friend page not found');
}
const { Content } = await render(friendPost);

const tocItems = [
  { depth: 2, slug: "friend-links", text: "友情链接" },
  { depth: 2, slug: "friend-circle-lite-root", text: "朋友圈" },
  { depth: 2, slug: "add-friend-instructions", text: "申请友链" },
  { depth: 2, slug: "comments-title", text: "评论" },
];

const cycleJsContent = fs.readFileSync('src/utils/cycle.js', 'utf-8');
---

<PostLayout title={title}>
  <div slot="rail" class="rail-wrapper">
    <div class="toc-wrapper">
      <Toc items={tocItems} />
    </div>
    <div class="rail-actions">
      <ScrollToTop />
      <ScrollToComment />
    </div>
  </div>

  <div class="friend-container">

    <div class="header-container">
      <div class="site-header">
        <PageHeader title={title} subtitle={description}>
          <Icon slot="icon" name="material-symbols:handshake-outline-rounded" class="w-11 h-11" />
        </PageHeader>
      </div>
    </div>
    <div class="content-wrapper">
      <div class="friend-links-container">
        <h2 id="friend-links">友情链接</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {friends.map((friend) => (
             <a href={friend.siteurl} target="_blank" rel="noopener noreferrer" class="friend-card no-underline group block p-4 rounded-xl border border-black/10 dark:border-white/10 bg-white/50 dark:bg-[#1e1e2e]/50 hover:bg-white dark:hover:bg-[#1e1e2e] transition-all duration-300 hover:scale-[1.02] hover:shadow-lg">
              <div class="flex items-start gap-4">
                <div class="relative shrink-0">
                  <img 
                    src={friend.imgurl} 
                    alt={friend.title}
                    class="friend-avatar w-16 h-16 rounded-full object-cover border-2 border-white dark:border-white/20 shadow-sm transition-colors"
                    loading="lazy"
                  />
                  <div class="absolute -bottom-1 -right-1 bg-white dark:bg-[#1e1e2e] rounded-full p-1 shadow-sm opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    <Icon name="material-symbols:arrow-outward" class="w-3 h-3 text-[var(--theme-color)]" />
                  </div>
                </div>
                
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    <h3 class="font-bold text-lg text-gray-900 dark:text-gray-100 truncate group-hover:text-[var(--theme-color)] transition-colors">
                      {friend.title}
                    </h3>
                  </div>
                  <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2 leading-relaxed">
                    {friend.desc}
                  </p>
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
      
      <div class="friend-circle-container">
        <div class="friend-circle-header">
           <h2>朋友圈</h2>
           <p class="text-sm text-gray-500 mt-2">这里展示最近朋友们的更新动态...</p>
        </div>
        
        <div id="friend-circle-lite-root"></div>
        <script is:inline>
            window.UserConfig = {
                private_api_url: 'https://circle-of-friends-iota.vercel.app/',
                page_turning_number: 12,
                error_img: 'https://fastly.jsdelivr.net/gh/Rock-Candy-Tea/Friend-Circle-Frontend/logo.png'
            }
        </script>
        <script is:inline set:html={cycleJsContent} />
      </div>

      <div class="add-friend-container">
        <h2 id="add-friend-instructions">申请友链</h2>
        <div class="prose dark:prose-invert max-w-none bg-white/50 dark:bg-[#1e1e2e]/50 p-6 rounded-xl border border-black/10 dark:border-white/10">
          <Content />
        </div>
      </div>

      <div class="comments-container">
        <h2 id="comments-title">评论</h2>
        <div id="comment-section">
           <Artalk />
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    function setupImageFallback() {
      const images = document.querySelectorAll('.friend-avatar');
      images.forEach(img => {
        // 如果图片已经加载失败（在脚本执行前）
        if (img.naturalWidth === 0 && img.complete) {
          handleImageError(img);
        }
        
        img.onerror = () => handleImageError(img);
      });
    }

    function handleImageError(img) {
      if (img.dataset.hasFallback) return;
      img.dataset.hasFallback = 'true';
      
      const name = img.alt || '?';
      const initial = name.charAt(0).toUpperCase();
      const parent = img.parentElement;
      
      const fallback = document.createElement('div');
      // 复制原有图片的所有类名，确保尺寸和圆角一致
      fallback.className = img.className;
      // 移除 object-cover 并添加 flex 居中样式
      fallback.classList.remove('object-cover');
      fallback.classList.add('flex', 'items-center', 'justify-center', 'text-2xl', 'font-bold');
      
      // 设置样式
      fallback.style.backgroundColor = 'var(--sidebar-icon-bg)';
      fallback.style.color = 'var(--theme-color)';
      fallback.innerText = initial;
      
      // 替换图片
      img.style.display = 'none';
      parent.insertBefore(fallback, img);
    }

    document.addEventListener('astro:page-load', setupImageFallback);
    // 立即尝试执行一次，以防 astro:page-load 不触发（如首次加载）
    setupImageFallback();
  </script>

  <style>
    .friend-container {
      max-width: 100%;
      margin: 0 auto;
    }
    
    .header-container {
      margin-bottom: 2rem;
    }

    .content-wrapper {
      display: flex;
      flex-direction: column;
      gap: 3rem;
    }

    .friend-links-container h2,
    .friend-circle-container h2,
    .add-friend-container h2,
    .comments-container h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      position: relative;
      padding-left: 1rem;
    }

    .friend-links-container h2::before,
    .friend-circle-container h2::before,
    .add-friend-container h2::before,
    .comments-container h2::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 1.2em;
      background-color: var(--theme-color);
      border-radius: 2px;
    }

    /* 朋友圈容器样式适配 */
    #friend-circle-lite-root {
      margin-top: 0;
      margin-bottom: 1rem;
    }

    /* 头像悬停边框颜色 - 对应 .friend-avatar */
    .friend-card:hover .friend-avatar {
      border-color: var(--theme-color);
    }

    @media (max-width: 768px) {
      .grid-cols-1 {
        grid-template-columns: 1fr;
      }
      .about-header {
        margin-bottom: 1.5rem;
      }
    }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</PostLayout>
