---
import Artalk from '@/components/util/Artalk.astro';
import { items as friends } from './page_data/friend.ts';
import Markdown from '@/components/util/Markdown.astro';
import { getEntry } from 'astro:content';
import { render } from 'astro:content';
import PageHeader from '@/components/page/PageHeader.astro';
import { Icon } from 'astro-icon/components';
import PostLayout from '@/layouts/PostLayout.astro';

const title = "友链";
const description = "一些朋友们的网站";
const friendPost = await getEntry("pages", "friend");
if (!friendPost) {
  throw new Error('Friend page not found');
}
const { Content } = await render(friendPost);
---

<PostLayout title={title}>
  <div class="friend-container">
    <PageHeader title={title} subtitle={description}>
      <Icon slot="icon" name="material-symbols:handshake-outline-rounded" class="w-11 h-11" />
    </PageHeader>

    <!-- 修复核心：网格容器添加 max-w-full 和 px-2 限制宽度，防止溢出 -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 2xl:grid-cols-3 gap-5">
      {friends.map((friend, index) => (
        <a 
          href={friend.siteurl}
          target="_blank"
          rel="noopener noreferrer"
          class="group flex flex-col p-4 sm:p-6 rounded-xl bg-[var(--content-pane-bg)] border border-[var(--line-divider)] shadow-sm hover:shadow-md transition-all duration-300 w-full hover:-translate-y-0.5 hover:ring-1 hover:ring-[var(--theme-color)]/20"
        >
          <div class="flex items-center mb-3">
            <div class="mr-3 flex-shrink-0" data-title={friend.title}>
              {friend.imgurl ? (
                <img 
                  src={friend.imgurl} 
                  alt={friend.title} 
                  class="w-10 h-10 rounded-full object-cover ring-2 ring-[var(--line-divider)] group-hover:ring-[var(--theme-color)]/50 flex-shrink-0 aspect-square overflow-hidden" 
                  loading="lazy"
                  decoding="async"
                  onerror="(function(el){var wrap=el.parentElement; el.style.display='none'; var t=(wrap.getAttribute('data-title')||'').trim(); var letter=t? t[0].toUpperCase():'?'; var s=document.createElement('span'); s.className='w-10 h-10 rounded-full flex items-center justify-center font-semibold ring-2 ring-[var(--line-divider)] group-hover:ring-[var(--theme-color)]/50 bg-[var(--sidebar-icon-bg)] text-[var(--text-primary)]'; s.textContent=letter; wrap.appendChild(s);})(this)"
                />
              ) : (
                <span class="w-10 h-10 rounded-full flex items-center justify-center font-semibold ring-2 ring-[var(--line-divider)] group-hover:ring-[var(--theme-color)]/50 bg-[var(--sidebar-icon-bg)] text-[var(--text-primary)] flex-shrink-0 aspect-square overflow-hidden">
                  {(friend.title || '?').charAt(0).toUpperCase()}
                </span>
              )}
            </div>
            <h2 class="text-lg font-semibold text-[var(--text-primary)] line-clamp-2 group-hover:text-[var(--theme-color)] flex-1 min-w-0" title={friend.title} style="overflow-wrap: break-word; word-break: break-all;">{friend.title}</h2>
          </div>
          
          <!-- 强制长文本换行，避免撑开宽度 -->
          <p class="text-[var(--text-secondary)] text-sm mb-3 line-clamp-2 leading-relaxed flex-1" 
             style="overflow-wrap: break-word; word-break: break-all;">
            {friend.desc || '暂无描述'}
          </p>
          
          <div class="flex flex-wrap gap-1.5 mt-auto">
            {friend.tags?.map((tag, tagIndex) => (
              <span 
                class="px-2 py-0.5 bg-[var(--tag-bg)] text-xs rounded-full text-[var(--text-secondary)] ring-1 ring-[var(--line-divider)]" 
                style="overflow-wrap: break-word; word-break: break-all;"
              >
                {tag}
              </span>
            ))}
          </div>
        </a>
      ))}
    </div>

    <div class="friend-notes-separator"></div>

    <Markdown>
      <Content />
    </Markdown>
    
    <section class="comments-section" aria-labelledby="comments-title">
      <h2 id="comments-title" class="comments-title">评论</h2>
      <div id="comment-section">
        <Artalk />
      </div>
    </section>
  </div>

  <style>
    .friend-container {
      max-width: var(--page-width);
      margin-left: 1rem;
      margin-right: 1rem;
    }

    .comments-section {
      margin-top: 2.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--line-divider);
    }

    .comments-title {
      text-align: center;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1rem;
    }

    #comment-section {
      max-width: var(--page-width);
      margin: 0 auto;
    }

    .link-requirements {
      margin-top: 2rem;
      padding-top: 1.25rem;
      border-top: 1px solid var(--line-divider);
    }

    .section-title {
      text-align: center;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.75rem;
    }

    .requirements-code {
      background: var(--content-pane-bg);
      border: 1px solid var(--line-divider);
      border-radius: 0.5rem;
      padding: 0.75rem;
      white-space: pre-wrap;
      line-height: 1.5;
    }

    .requirements-list {
      margin-top: 0.75rem;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .requirements-list .link {
      color: var(--theme-color);
      text-decoration: none;
    }

    .requirements-list .link:hover {
      text-decoration: underline;
    }

    .friend-notes-separator {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--line-divider);
    }

    @media (max-width: 1023px) {
      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .link-requirements, .comments-section {
        margin-top: 1.5rem;
        padding-top: 1rem;
      }
      .friend-notes-separator {
        margin-top: 1.25rem;
        padding-top: 0.75rem;
      }
    }

    /* 移动端核心修复：彻底限制宽度，消除水平滚动 */
    @media (max-width: 639px) {
      .grid {
        grid-template-columns: 1fr; /* 移动端强制单列 */
      }

      .friend-container {
        max-width: 100vw !important; /* 限制最大宽度为视口宽度 */
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        box-sizing: border-box; /* 确保内边距不增加总宽度 */
      }

      #comment-section {
        max-width: 100vw !important;
        padding-left: 0.5rem;
        padding-right: 0.5rem;
        box-sizing: border-box;
      }

      /* 紧急防护：禁止页面水平滚动 */
      html, body {
        overflow-x: hidden !important;
      }

      /* 优化移动端内边距，减少宽度压力 */
      .about-title {
        font-size: 1.75rem;
      }
      .about-header {
        margin-bottom: 1.5rem;
      }
    }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</PostLayout>
