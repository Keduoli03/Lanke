---
import PageHeader from '@/components/page/PageHeader.astro';
import MainLayout from '../layouts/MainLayout.astro';
import { Icon } from 'astro-icon/components';
import Markdown from '@/components/util/Markdown.astro';

const title = '说说';
---
<MainLayout title={title}>
  <div class="memos">
    <!-- 头部区域 -->
    <PageHeader title="说说" subtitle="记录瞬间">
      <Icon slot="icon" name="material-symbols:archive-outline" class="w-11 h-11" />
    </PageHeader>

    <!-- 说说列表容器（多列布局） -->
    <section class="memos-list">
      <div id="memo-grid" class="memos-grid"></div>
    </section>

    <!-- 单条说说模板 -->
    <template id="memo-item-template">
      <article class="memos-item">
        <div class="memos-content prose dark:prose-invert"></div>
        <div class="memos-footer">
          <time class="memos-time"></time>
          <button class="memos-comments">评论<span class="artalk-count" data-page-key=""></span></button>
        </div>
        <div class="comment d-none"></div>
      </article>
    </template>

    <!-- 加载更多按钮 -->
    <div class="bb-load" id="load-more-container"></div>

    <script is:inline>
      const CONFIG = {
        memos: {
          baseUrl: 'https://memos.blueke.top/',
          limit: 10,
          creatorId: '1',
          username: 'lanke',
          userlink: 'https://memos.blueke.top',
          commentsShow: true,
          commentsTitle: '评论'
        },
        artalk: {
          site: 'Memos',
          server: 'https://artalk.blueke.top',
          commentsUrl: 'https://memos.blueke.top/m/'
        },
        dom: {
          gridContainer: '#memo-grid',
          template: '#memo-item-template',
          loadMore: '#load-more-container'
        }
      };

      let nextToken = '';
      const limit = parseInt(CONFIG.memos.limit, 10);
      const memoGrid = document.querySelector(CONFIG.dom.gridContainer);
      const memoTemplate = document.querySelector(CONFIG.dom.template);
      const loadMoreContainer = document.querySelector(CONFIG.dom.loadMore);

      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hour = String(date.getHours()).padStart(2, '0');
        const minute = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day} ${hour}:${minute}`;
      }

      function renderMarkdownBasic(text) {
        if (!text) return '';
        let s = text
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');

        s = s.replace(/```([\s\S]*?)```/g, (_, code) => `<pre><code>${code.replace(/&/g, '&amp;')}</code></pre>`);
        s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
        s = s.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>')
             .replace(/^##\s+(.*)$/gm, '<h2>$1</h2>')
             .replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
        s = s.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
             .replace(/\*([^*]+)\*/g, '<em>$1</em>');
        s = s.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img alt="$1" src="$2" class="memo-img" />');
        s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" class="memo-link">$1</a>');
        s = s.replace(/^>\s+(.*)$/gm, '<blockquote>$1</blockquote>');
        s = s.replace(/^(?:-\s.*(?:\r?\n|$))+?/gm, (block) => {
          const items = block.trim().split(/\r?\n/).map(l => l.replace(/^-+\s?/, '').trim());
          const li = items.filter(Boolean).map(i => `<li>${i}</li>`).join('');
          return `<ul>${li}</ul>`;
        });
        s = s.split(/\n{2,}/).map(chunk => {
          if (/^\s*(<h\d|<ul|<pre|<blockquote|<img|<p)/.test(chunk)) return chunk;
          const lines = chunk.split(/\n/).map(l => l.trim()).filter(Boolean);
          if (!lines.length) return '';
          return `<p>${lines.join('<br/>')}</p>`;
        }).join('\n');

        return s;
      }

      function renderMemoItem(memo) {
        const isoTime = memo.displayTime || memo.createTime;
        const createdDate = isoTime ? new Date(isoTime) : new Date();
        const memoId = (memo.name || '').split('/').pop() || String(memo.id || Date.now());

        const frag = memoTemplate.content.cloneNode(true);
        const contentEl = frag.querySelector('.memos-content');
        contentEl.innerHTML = renderMarkdownBasic(memo.content || '');
        contentEl.querySelectorAll('img').forEach(img => {
          const src = img.getAttribute('src') || '';
          if (/^\/(attachments|resources|o)\//.test(src)) {
            img.src = `${CONFIG.memos.baseUrl}${src.slice(1)}`;
          } else if (/^(attachments|resources|o)\//.test(src)) {
            img.src = `${CONFIG.memos.baseUrl}${src}`;
          }
        });
        if (Array.isArray(memo.attachments) && memo.attachments.length) {
          const wrap = document.createElement('div');
          wrap.className = 'memos-attachments';
          memo.attachments.forEach(att => {
            const id = (att.name || '').split('/').pop();
            const isImg = (att.type || '').startsWith('image/');
            if (isImg) {
              const candidates = [];
              if (att.externalLink) candidates.push(att.externalLink);
              if (id) {
                candidates.push(`${CONFIG.memos.baseUrl}api/v2/attachments/${id}/raw`);
                candidates.push(`${CONFIG.memos.baseUrl}api/v1/attachments/${id}/raw`);
                candidates.push(`${CONFIG.memos.baseUrl}o/${id}`);
              }
              const img = document.createElement('img');
              img.className = 'memo-img';
              let i = 0;
              const tryNext = () => {
                if (i >= candidates.length) return;
                img.src = candidates[i++];
              };
              img.addEventListener('error', tryNext);
              tryNext();
              wrap.appendChild(img);
            } else {
              const a = document.createElement('a');
              a.href = att.externalLink || (id ? `${CONFIG.memos.baseUrl}api/v1/attachments/${id}/raw` : '#');
              a.textContent = att.filename || '附件';
              a.target = '_blank';
              a.rel = 'noopener noreferrer';
              a.className = 'memo-link';
              wrap.appendChild(a);
            }
          });
          contentEl.appendChild(wrap);
        }
        frag.querySelector('.memos-time').textContent = formatDate(createdDate);
        
        const commentBtn = frag.querySelector('.memos-comments');
        const commentCount = frag.querySelector('.artalk-count');
        commentBtn.setAttribute('data-id', memoId);
        commentCount.setAttribute('data-page-key', `/m/${memoId}`);
        frag.querySelector('.comment').id = memoId;

        commentBtn.addEventListener('click', () => loadArtalk(commentBtn));
        return frag;
      }

      function loadArtalk(btn) {
        const id = btn.getAttribute('data-id') || '';
        const artalkDom = document.getElementById(id);
        if (!artalkDom) return;

        document.querySelectorAll('.comment').forEach(item => item.classList.add('d-none'));
        const existingArtalk = document.getElementById('artalk');
        if (existingArtalk) existingArtalk.remove();

        if (artalkDom.classList.contains('d-none')) {
          artalkDom.insertAdjacentHTML('beforeend', '<div id="artalk"></div>');
          artalkDom.classList.remove('d-none');
          if (typeof Artalk !== 'undefined' && Artalk.init) {
            Artalk.init({
              el: '#artalk',
              pageKey: `/m/${id}`,
              pageTitle: '',
              site: CONFIG.artalk.site,
              server: CONFIG.artalk.server,
              emoticons: false
            });
          }
        } else {
          artalkDom.classList.add('d-none');
        }
      }

      function updateMemoList(data = []) {
        if (!memoGrid || data.length === 0) return;
        data.forEach(memo => memoGrid.appendChild(renderMemoItem(memo)));
      }

      function initLoadMoreBtn() {
        loadMoreContainer.innerHTML = '<button class="load-btn button-load">加载中…</button>';
        const btn = loadMoreContainer.querySelector('.button-load');
        btn.addEventListener('click', () => {
          btn.textContent = '加载中…';
          getNextPageMemos().then(() => btn.textContent = '加载更多');
        });
        return btn;
      }

      async function getFirstPageMemos() {
        const btn = initLoadMoreBtn();
        const url = `${CONFIG.memos.baseUrl}api/v1/memos?creatorId=${CONFIG.memos.creatorId}&rowStatus=NORMAL&limit=${limit}`;
        try {
          const res = await fetch(url);
          const resdata = await res.json();
          const list = Array.isArray(resdata) ? resdata : (resdata.memos || []);
          nextToken = resdata?.nextPageToken || '';
          updateMemoList(list);
          if (!nextToken || list.length < limit) loadMoreContainer.innerHTML = '';
          else btn.textContent = '加载更多';
        } catch (err) {
          console.error('初始加载失败:', err);
          memoGrid.innerHTML = '<div class="memo-error">加载失败，请检查网络</div>';
          loadMoreContainer.innerHTML = '';
        }
      }

      async function getNextPageMemos() {
        if (!nextToken) {
          loadMoreContainer.innerHTML = '';
          return;
        }
        const url = `${CONFIG.memos.baseUrl}api/v1/memos?creatorId=${CONFIG.memos.creatorId}&rowStatus=NORMAL&limit=${limit}&pageToken=${encodeURIComponent(nextToken)}`;
        try {
          const res = await fetch(url);
          const resdata = await res.json();
          const list = Array.isArray(resdata) ? resdata : (resdata.memos || []);
          nextToken = resdata?.nextPageToken || '';
          updateMemoList(list);
          if (!nextToken || list.length < 1) loadMoreContainer.innerHTML = '';
          if (typeof Artalk !== 'undefined' && Artalk.loadCountWidget) {
            Artalk.loadCountWidget({
              server: CONFIG.artalk.server,
              site: CONFIG.artalk.site,
              countEl: '.artalk-count'
            });
          }
        } catch (err) {
          console.error('分页加载失败:', err);
          loadMoreContainer.innerHTML = '<div class="memo-error">加载更多失败</div>';
        }
      }

      if (memoGrid && memoTemplate) getFirstPageMemos();
    </script>
  </div>
</MainLayout>

<style is:inline>
  :root {
    --color-border: var(--line-divider);
    --color-bg-1: var(--content-pane-bg);
    --text-muted: var(--text-secondary);
    --color-link: var(--text-link);
    --grid-gap: 16px;
    --card-min-width: 220px;
  }

  .dark {
    --color-border: var(--line-divider);
    --color-bg-1: var(--content-pane-bg);
    --text-muted: var(--text-secondary);
    --color-link: var(--text-link);
  }

  .memos {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .memos .page-title {
    margin: 0 !important;
    font-size: 1.1rem !important;
    line-height: 1.15 !important;
    display: inline-flex !important;
    align-items: center;
    gap: 0.25rem !important;
  }

  .memos .page-title :global(svg) {
    width: 1rem !important;
    height: 1rem !important;
  }

  .memos .page-subtitle {
    margin: 0.12rem 0 0.4rem !important;
    font-size: 0.85rem !important;
    line-height: 1.2 !important;
  }

  /* 多列布局保持不变 */
  .memos-list {
    margin-top: 0.4rem;
  }

  .memos-grid {
    column-count: 4;
    column-gap: var(--grid-gap);
    width: 100%;
    column-width: var(--card-min-width);
  }

  /* 卡片样式保持不变 */
  .memos-item {
    display: flex;
    flex-direction: column;
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 12px 14px;
    background: var(--color-bg-1);
    transition: box-shadow 0.2s ease;
    break-inside: avoid;
    margin-bottom: var(--grid-gap);
  }

  .memos-item:hover {
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
  }

  /* 内容区域：缩小整体字体基数 */
  .memos-content.prose {
    font-size: 1rem !important; /* 从0.92rem缩小到0.88rem */
    line-height: 1.5 !important; /* 轻微降低行高，更紧凑 */
    color: var(--text-primary) !important;
    margin: 0 !important;
    padding: 0 !important;
    flex: 1;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    word-break: break-all !important;
    white-space: normal !important;
  }

  .memos-content.prose h1,
  .memos-content.prose h2,
  .memos-content.prose h3 {
    margin: 0.3rem 0 0.15rem !important; /* 缩小上下间距 */
    font-size: 1.1rem !important; /* 从1.05rem缩小到0.92rem，仅比正文略大 */
    font-weight: 500 !important; /* 降低字体权重，不那么厚重 */
    line-height: 1.4 !important;
  }

  /* 段落样式：同步缩小间距 */
  .memos-content.prose p {
    margin: 0.2rem 0 !important; /* 从0.25rem缩小 */
  }

  .memos-content.prose ul {
  margin: 0.2rem 0 0.3rem 0.4rem !important; 
  padding-left: 1.2rem !important; 
  margin-left: 0 !important;
}

.memos-content.prose li {
  margin: 0.1rem 0 !important; 
  font-size: 0.86rem !important;
  line-height: 1.45 !important;
  text-indent: -0.5em !important; 
  padding-left: 0.5em !important;
}

.memos-content.prose li::marker {
  font-size: 0.9em !important; /* 符号大小稍调小，视觉上更紧凑 */
}

  .memos-content.prose blockquote {
    margin: 0.3rem 0 !important; /* 从0.4rem缩小 */
    padding: 0.2rem 0.5rem !important; /* 缩小内边距 */
    font-size: 0.84rem !important; /* 比正文略小 */
  }

  /* 图片样式保持不变 */
  .memo-img {
    max-width: 100% !important;
    height: auto !important;
    border-radius: 6px !important;
    margin: 0.3rem 0 !important; /* 缩小上下间距 */
  }

  /* 链接样式：同步缩小 */
  .memo-link {
    color: var(--color-link) !important;
    text-decoration: underline !important;
    display: inline-block !important;
    font-size: 0.86rem !important; /* 比正文略小 */
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
  }

  /* 底部区域保持不变 */
  .memos-footer {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 8px;
    margin-top: auto;
    padding-top: 0.5rem !important;
    border-top: 1px solid var(--color-border);
    line-height: 1 !important;
  }

  .memos-time {
    font-size: 0.7rem !important;
    color: var(--text-muted);
    white-space: nowrap;
  }

  /* 彻底解决左右内边距不一致：用flex布局+强制样式覆盖 */
.memos-comments {
  display: flex !important; /* 替换inline-flex，避免父元素text-align干扰 */
  align-items: center !important;
  justify-content: center !important; /* 内部内容绝对居中 */
  font-size: 0.75rem !important;
  color: var(--theme-color);
  background: var(--tag-bg);
  border: 1px solid var(--line-divider);
  /* 强制统一左右内边距（数值可按需调整，这里用8px保持原大小） */
  padding-left: 8px !important;
  padding-right: 8px !important;
  padding-top: 4px !important;
  padding-bottom: 4px !important;
  margin: 0 !important;
  margin-left: auto !important; /* 保持靠右对齐 */
  border-radius: 8px !important;
  cursor: pointer;
  transition: all 0.2s ease !important;
  box-sizing: border-box !important; /* 内边距不影响宽度 */
  white-space: nowrap !important; /* 内容不换行 */
  text-align: center !important; /* 文字绝对居中，消除偏移 */
  outline: none !important; /* 清除默认轮廓 */
  appearance: none !important; /* 清除浏览器默认样式 */
}

/* 计数元素：仅保留必要间距，不干扰内边距 */
.memos-comments .artalk-count {
  margin-left: 3px !important; /* 文字和计数的间距 */
  margin-right: 0 !important; /* 强制清除右边间距 */
  padding: 0 !important;
}

.memos-comments:hover {
  background: var(--theme-color);
  border-color: var(--theme-color);
  color: #fff;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
}


  /* 加载更多按钮保持不变 */
  .bb-load {
    margin: 1rem 0 2rem;
    column-span: all;
  }

  .button-load {
    width: 100% !important;
    font-size: 0.8rem;
    background: none;
    border-radius: 10px;
    border: 1px solid var(--color-border);
    padding: 10px 30px;
    letter-spacing: 0.8rem;
    text-align: center;
    color: var(--text-muted);
    cursor: pointer;
    transition: border-color 0.2s ease;
  }

  .button-load:hover {
    border-color: var(--color-link);
    color: var(--color-link);
  }

  /* 错误提示保持不变 */
  .memo-error {
    text-align: center;
    color: #ef4444;
    padding: 1rem;
    font-size: 0.9rem;
    column-span: all;
  }

  /* 响应式适配保持不变 */
  @media (max-width: 1024px) {
    .memos-grid {
      column-count: 2;
    }
  }

  @media (max-width: 640px) {
    .memos-grid {
      column-count: 1;
    }

    .memos-item {
      padding: 10px 12px;
      margin-bottom: 12px;
    }

    .memos-content.prose {
      font-size: 0.86rem !important;
    }

    .memos-content.prose h1,
    .memos-content.prose h2,
    .memos-content.prose h3 {
      font-size: 0.9rem !important;
    }

    .memos-time, .memos-comments {
      font-size: 0.68rem !important;
    }
  }
</style>
