---
import MainLayout from '../layouts/MainLayout.astro';

const title = 'Misskey åŠ¨æ€';
---
<MainLayout title={title}>
    <div class="misskey-timeline">
        <header class="archive-header">
            <h1 class="archive-title">æˆ‘çš„åŠ¨æ€</h1>
            <p class="archive-subtitle">ç‚¹å‡»è¯¦æƒ…å¯è·³è½¬åˆ° Misskey</p>
        </header>
        
        <div id="timeline-container" class="timeline-container">
            <!-- åŠ è½½çŠ¶æ€ -->
            <div class="loading">
                <div class="spinner"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        const MISSKEY_INSTANCE = 'https://memo.blueke.top';
        const USER_ID = 'adfztpsih1jc0003';
        const LIMIT = 20;

        // Misskey ç±»å‹
        interface MisskeyUser {
            id: string;
            username?: string;
            name?: string;
            avatarUrl?: string;
        }
        interface MisskeyFile { url: string }
        interface MisskeyNote {
            id: string;
            userId: string;
            createdAt: string;
            text?: string;
            files?: MisskeyFile[];
            renoteId?: string;
            replyId?: string;
            user?: MisskeyUser;
        }

        // å·¥å…·å‡½æ•°ï¼šè·å–å®Œæ•´URLï¼ˆæ”¯æŒç©ºå€¼ï¼‰
        const absUrl = (p: string | null | undefined): string => {
            if (!p) return '';
            try { return new URL(p, MISSKEY_INSTANCE).href; } catch { return p; }
        };
        
        // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸï¼ˆæ˜¾å¼ç±»å‹ + getTimeï¼‰
        function formatDate(dateString: string): string {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs: number = now.getTime() - date.getTime();
            const diffDays: number = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const pad = (num: number) => num.toString().padStart(2, '0');

            if (diffDays === 0) return `ä»Šå¤© ${pad(date.getHours())}:${pad(date.getMinutes())}`;
            if (diffDays === 1) return `æ˜¨å¤© ${pad(date.getHours())}:${pad(date.getMinutes())}`;
            if (diffDays < 365) return `${pad(date.getMonth() + 1)}æœˆ${pad(date.getDate())}æ—¥ ${pad(date.getHours())}:${pad(date.getMinutes())}`;
            return `${date.getFullYear()}å¹´${pad(date.getMonth() + 1)}æœˆ${pad(date.getDate())}æ—¥`;
        }

        function getNoteDetailUrl(noteId: string): string {
            return `${MISSKEY_INSTANCE}/notes/${noteId}`;
        }

        async function fetchReplies(noteId: string, limit: number = 5): Promise<MisskeyNote[]> {
            try {
                const res = await fetch(`${MISSKEY_INSTANCE}/api/notes/children`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ noteId, limit })
                });
                if (!res.ok) return [];
                return await res.json();
            } catch (err) {
                console.error('è·å–å›å¤å¤±è´¥:', err);
                return [];
            }
        }

        async function fetchQuotedNote(noteId: string): Promise<MisskeyNote | null> {
            try {
                const res = await fetch(`${MISSKEY_INSTANCE}/api/notes/show`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ noteId })
                });
                if (!res.ok) return null;
                return await res.json();
            } catch (err) {
                console.error('è·å–å¼•ç”¨å¸–å­å¤±è´¥:', err);
                return null;
            }
        }

        async function renderQuotedNote(quotedNoteId: string | undefined): Promise<string> {
            if (!quotedNoteId) return '';
            const quotedNote = await fetchQuotedNote(quotedNoteId);
            if (!quotedNote) return '';
            const quotedUrl = getNoteDetailUrl(quotedNoteId);
            const quotedTime = formatDate(quotedNote.createdAt);
            
            return `
                <div class="quoted-note">
                    <div class="quoted-header">
                        <img src="${absUrl(quotedNote.user?.avatarUrl)}" class="quoted-avatar" 
                             alt="${quotedNote.user?.name}çš„å¤´åƒ" loading="lazy" />
                        <div class="quoted-author-info">
                            <span class="quoted-author">${quotedNote.user?.name || quotedNote.user?.username}</span>
                            <span class="quoted-time">${quotedTime}</span>
                        </div>
                    </div>
                    <div class="quoted-content">${quotedNote.text || '[æ— å†…å®¹]'}</div>
                    ${quotedNote.files && quotedNote.files.length > 0 ? 
                        `<div class="quoted-media">
                            <img src="${absUrl(quotedNote.files[0].url)}" alt="å¼•ç”¨å†…å®¹å›¾ç‰‡" loading="lazy" />
                        </div>` : ''
                    }
                    <a href="${quotedUrl}" target="_blank" class="quoted-link" rel="noopener noreferrer">
                        æŸ¥çœ‹åŸæ–‡
                    </a>
                </div>
            `;
        }

        // ä¸»å‡½æ•°ï¼šè·å–å¹¶æ¸²æŸ“æ—¶é—´çº¿ï¼ˆä¿ç•™ç°æœ‰å®ç°ï¼‰
        async function fetchMisskeyTimeline(): Promise<void> {
            const container = document.getElementById('timeline-container') as HTMLDivElement | null;
            if (!container) return;

            // åˆå§‹åŠ è½½æ€
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            `;

            try {
                const userRes = await fetch(`${MISSKEY_INSTANCE}/api/users/show`, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ userId: USER_ID })
                });
                const user: MisskeyUser = await userRes.json();
                const currentUserId: string = user.id;

                const timelineRes = await fetch(`${MISSKEY_INSTANCE}/api/users/notes`, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: USER_ID, limit: LIMIT, withReplies: true })
                });
                const notes: MisskeyNote[] = await timelineRes.json();

                const filteredNotes: MisskeyNote[] = notes.filter((note: MisskeyNote) => {
                    if (!note.replyId) return true;
                    return note.userId !== currentUserId;
                });

                container.innerHTML = '';
                if (filteredNotes.length === 0) {
                    container.innerHTML = '<div class="no-posts">æš‚æ— å†…å®¹</div>';
                    return;
                }

                for (const note of filteredNotes) {
                    const postCard = document.createElement('div');
                    postCard.className = 'post-card';
                    const formattedTime = formatDate(note.createdAt);
                    const isOwnPost = note.userId === currentUserId;
                    const noteUrl = getNoteDetailUrl(note.id);

                    const quotedHtml = note.renoteId && note.renoteId !== note.id 
                        ? await renderQuotedNote(note.renoteId) 
                        : '';

                    postCard.innerHTML = `
                        <div class="post-header">
                            <img src="${absUrl(note.user?.avatarUrl || user.avatarUrl)}" class="avatar" 
                                 alt="${note.user?.name || user.name}çš„å¤´åƒ" loading="lazy" />
                            <span class="author-name">
                                <a href="${absUrl(`/@${note.user?.username || user.username}`)}" target="_blank" rel="noopener noreferrer">
                                    ${note.user?.name || note.user?.username || user.name}
                                </a>
                            </span>
                            <div class="header-actions">
                                <span class="post-time">
                                    <a href="${noteUrl}" target="_blank" rel="noopener noreferrer">
                                        ${formattedTime}
                                    </a>
                                </span>
                                <a href="${noteUrl}" target="_blank" rel="noopener noreferrer" class="action-link view-detail">
                                    <i class="icon-detail"></i> è¯¦æƒ…
                                </a>
                            </div>
                        </div>
                        <div class="post-content">${note.text || ''}</div>
                        ${quotedHtml}
                        ${note.files && note.files.length > 0 ? 
                            `<div class="post-media">
                                <a href="${noteUrl}" target="_blank" rel="noopener noreferrer">
                                    <img src="${absUrl(note.files[0].url)}" alt="é™„ä»¶å›¾ç‰‡" loading="lazy" />
                                </a>
                            </div>` : ''
                        }
                        <div class="replies" data-note-id="${note.id}"></div>
                    `;

                    const repliesWrap = postCard.querySelector<HTMLDivElement>('.replies');
                    if (isOwnPost && repliesWrap) {
                        const replies: MisskeyNote[] = await fetchReplies(note.id, 5);
                        if (Array.isArray(replies) && replies.length > 0) {
                            const replyCount = document.createElement('div');
                            replyCount.className = 'reply-count';
                            replyCount.textContent = `å…± ${replies.length} æ¡å›å¤`;
                            repliesWrap.appendChild(replyCount);

                            replies.forEach((r: MisskeyNote) => {
                                const item = document.createElement('div');
                                item.className = 'reply';
                                const replyTime = formatDate(r.createdAt);
                                const rUser = r.user || {} as MisskeyUser;
                                const replyUrl = getNoteDetailUrl(r.id);
                                item.innerHTML = `
                                    <img src="${absUrl(rUser.avatarUrl)}" class="avatar" alt="${rUser.name || rUser.username || 'ç”¨æˆ·'}å¤´åƒ" loading="lazy" />
                                    <div class="reply-body">
                                        <div class="author-name">
                                            <a href="${absUrl(`/@${rUser.username}`)}" target="_blank" rel="noopener noreferrer">
                                                ${rUser.name || rUser.username || 'ç”¨æˆ·'}
                                            </a>
                                            <span class="post-time" style="margin-left: 8px;">
                                                <a href="${replyUrl}" target="_blank" rel="noopener noreferrer">
                                                    ${replyTime}
                                                </a>
                                            </span>
                                        </div>
                                        <div class="reply-text">${r.text || ''}</div>
                                    </div>
                                `;
                                repliesWrap.appendChild(item);
                            });
                        } else {
                            repliesWrap.style.display = 'none';
                        }
                    } else if (repliesWrap) {
                        repliesWrap.style.display = 'none';
                    }

                    container.appendChild(postCard);
                }
            } catch (err) {
                const msg = (err && typeof err === 'object' && 'message' in err) ? (err as any).message : String(err);
                container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${msg}</div>`;
                console.error('è·å–Misskeyæ•°æ®å¤±è´¥:', err);
            }
        }

        // ç»Ÿä¸€åˆå§‹åŒ–ï¼šé¡µé¢åŠ è½½ä¸è§†å›¾äº¤æ¢éƒ½è§¦å‘ï¼Œä½†åŒä¸€é¡µé¢åªæ‰§è¡Œä¸€æ¬¡
        function initTimeline(): void {
            const container = document.getElementById('timeline-container') as HTMLDivElement | null;
            if (!container) return;
            if (container.dataset.init === '1') return; // å·²åˆå§‹åŒ–ï¼Œé¿å…é‡å¤
            container.dataset.init = '1';
            fetchMisskeyTimeline();
        }

        // é¦–æ¬¡è¿›å…¥é¡µé¢ï¼ˆç›´æ¥åŠ è½½æˆ– SSR æ¸²æŸ“åï¼‰
        if (document.readyState !== 'loading') {
            initTimeline();
        } else {
            window.addEventListener('DOMContentLoaded', initTimeline, { once: true });
        }

        // Astro å®¢æˆ·ç«¯å¯¼èˆªäº‹ä»¶ï¼šè¿›å…¥é¡µé¢åè§¦å‘
        document.addEventListener('astro:page-load', initTimeline);
        // Astro è§†å›¾è¿‡æ¸¡ï¼šDOM äº¤æ¢å®Œæˆåè§¦å‘
        document.addEventListener('astro:after-swap', initTimeline);

        // å¦‚ä¹‹å‰æœ‰ didLoad/dataset.loaded/pageshow çš„æ—§é€»è¾‘ï¼Œè¯·ç§»é™¤ï¼Œé¿å…ç›¸äº’å¹²æ‰°
    </script>
</MainLayout>



<style is:global>
        .misskey-timeline { 
            max-width: 1000px;
            margin: 0 auto; 
            padding: 20px; 
        }

        /* ç»Ÿä¸€åˆ°å½’æ¡£é¡µæ ·å¼çš„æ ‡é¢˜åŒºå— */
        .archive-header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--line-divider);
            width: 100%;
        }
        .archive-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            line-height: 1;
        }
        .archive-subtitle {
            color: var(--text-secondary);
            font-size: 1.125rem;
            margin: 0;
        }

        /* åŸ section-header å¯ç§»é™¤æˆ–ä¿ç•™ä¸ä½¿ç”¨ */
        .section-header {
            display: none;
        }

        .section-header {
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .section-header h2 {
            margin: 0 0 8px 0;
            color: #2d3748;
            font-size: 1.5rem;
        }

        .filter-info { 
            color: #666; 
            font-size: 0.9rem; 
        }

        .timeline-container { 
            display: grid; 
            gap: 24px; 
        }

        .post-card { 
            background: white; 
            border-radius: 12px; 
            padding: 20px; 
            box-shadow: 0 2px 12px rgba(0,0,0,0.04); 
            border: 1px solid #f0f0f0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
        }

        .post-header { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-bottom: 16px; 
        }

        .header-actions {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .avatar { 
            display: block; 
            width: 44px; 
            height: 44px; 
            flex: 0 0 44px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 1px solid #f0f0f0;
        }

        .author-name { 
            font-weight: 600; 
            color: #2d3748; 
            font-size: 1rem;
        }

        .author-name a, .post-time a {
            color: inherit;
            text-decoration: none;
        }

        .author-name a:hover, .post-time a:hover {
            text-decoration: underline;
        }

        .post-time { 
            color: #9ca3af; 
            font-size: 0.85rem; 
        }

        .post-content { 
            color: #4a5568; 
            line-height: 1.7; 
            margin-bottom: 16px;
            font-size: 1rem;
            padding: 0 3rem;
        }

        /* å¸–å­å¼•ç”¨æ ·å¼ */
        .quoted-note {
            margin: 12px 0;
            padding: 12px;
            background-color: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            font-size: 0.95rem;
        }

        .quoted-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .quoted-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }

        .quoted-author-info {
            flex: 1;
        }

        .quoted-author {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9rem;
        }

        .quoted-time {
            color: #9ca3af;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        .quoted-content {
            color: #4b5563;
            line-height: 1.5;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .quoted-media {
            margin: 8px 0;
            border-radius: 4px;
            overflow: hidden;
            max-width: 300px;
        }

        .quoted-media img {
            width: 100%;
            height: auto;
            object-fit: cover;
        }

        .quoted-link {
            display: inline-block;
            color: #3b82f6;
            font-size: 0.85rem;
            text-decoration: none;
        }

        .quoted-link:hover {
            text-decoration: underline;
        }

        /* å›¾ç‰‡æ ·å¼ */
        .post-media {
          margin: 16px auto;
          border-radius: 8px;
          overflow: hidden;
          width: clamp(280px, 80%, 720px);
          max-width: 100%;
          box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .post-media img {
          display: block;
          width: 100%;
          height: auto;
          max-height: 420px;
          margin: 0 auto;
          object-fit: contain;
          transition: transform 0.3s ease;
        }
        
        .post-media:hover img {
            transform: scale(1.01);
        }

        /* æ“ä½œæŒ‰é’®æ ·å¼ */
        .action-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #3b82f6;
            font-size: 0.9rem;
            background: none;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
        }

        .action-link:hover {
            background-color: #eff6ff;
        }

        .icon-detail::before {
            content: 'ğŸ”';
        }

        /* å›å¤æ ·å¼ */
        .replies { 
            margin-top: 16px; 
            padding-top: 16px; 
            border-top: 1px dashed #e5e7eb; 
            padding-left: 3rem;
        }
        
        .reply-count {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .reply { 
            display: flex; 
            gap: 10px; 
            padding: 10px 0; 
        }

        .reply .avatar { 
            width: 32px; 
            height: 32px; 
            flex: 0 0 32px; 
        }

        .reply-body { 
            flex: 1; 
            padding-left: 10px;
        }

        .reply-text { 
            color: #4a5568;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading { 
            text-align: center; 
            padding: 60px 20px; 
            color: #666; 
        }

        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 16px;
            border: 3px solid #f0f0f0;
            border-top: 3px solid #6b7280;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error { 
            text-align: center; 
            padding: 60px 20px; 
            color: #dc3545; 
            background-color: #fef2f2;
            border-radius: 8px;
        }

        .no-posts { 
            text-align: center; 
            padding: 60px 20px; 
            color: #666; 
            background-color: #f9fafb;
            border-radius: 8px;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .misskey-timeline {
                padding: 12px;
            }
            
            .post-card {
                padding: 16px;
            }
            
            .post-content, .replies {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            .post-content {
                font-size: 0.95rem;
            }
            
            .post-media {
                width: 100%;
            }
            
            .post-media img {
                max-height: 320px;
            }
            
            .header-actions {
                gap: 8px;
            }
            
            .action-link {
                font-size: 0.85rem;
                padding: 2px 6px;
            }
        }
    </style>
