---
import PageHeader from '@/components/page/PageHeader.astro';
import MainLayout from '../layouts/MainLayout.astro';
import { Icon } from 'astro-icon/components';
import Markdown from '@/components/util/Markdown.astro';

const title = 'è¯´è¯´';
---
<MainLayout title={title}>
  <div class="memos">
    <!-- å¤´éƒ¨åŒºåŸŸ -->
    <PageHeader title="è¯´è¯´" subtitle="è®°å½•ç¬é—´">
      <Icon slot="icon" name="material-symbols:archive-outline" class="w-11 h-11" />
    </PageHeader>

    <!-- è¯´è¯´åˆ—è¡¨å®¹å™¨ï¼ˆå¤šåˆ—å¸ƒå±€ï¼‰ -->
    <section class="memos-list">
      <div id="memo-grid" class="memos-grid"></div>
    </section>
    <div id="memos-comment-global" class="comment-global d-none"></div>
    <div id="memos-reaction-global" class="reaction-global d-none"></div>

    <!-- å•æ¡è¯´è¯´æ¨¡æ¿ -->
    <template id="memo-item-template">
      <article class="memos-item">
        <div class="memos-content prose dark:prose-invert"></div>
        <!-- æ–°å¢ååº”å®¹å™¨ -->
        <div class="emaction-container"></div>
        <div class="memos-footer">
          <time class="memos-time"></time>
          <button class="memos-reactions">ååº”</button>
          <button class="memos-comments">è¯„è®º<span class="artalk-count" data-page-key=""></span></button>
        </div>
        <div class="comment d-none"></div>
      </article>
    </template>

    <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
    <div class="bb-load" id="load-more-container"></div>

    <script is:inline>// ååº”åŠŸèƒ½æ ¸å¿ƒç±»
class Emaction {
  constructor(config) {
    // åˆå¹¶é…ç½®
    this.config = {
      emactionApi: 'https://emaction-go.mintimate.cn',
      memoId: '',
      ...config
    };
    
    // è¡¨æƒ…æ•°æ®ï¼ˆä½¿ç”¨emojiç¬¦å·ä½œä¸ºç±»å‹æ ‡è¯†ï¼Œä¸APIçš„reactionTypeåŒ¹é…ï¼‰
    this.emojis = [
      { code: 'ğŸ‘', type: 'ğŸ‘' },
      { code: 'â¤ï¸', type: 'â¤ï¸' },
      { code: 'ğŸ˜„', type: 'ğŸ˜„' },
      { code: 'ğŸ‰', type: 'ğŸ‰' },
      { code: 'ğŸ˜•', type: 'ğŸ˜•' },
      { code: 'ğŸ‘€', type: 'ğŸ‘€' }
    ];
    
    // åˆå§‹åŒ–çŠ¶æ€
    this.reactions = {};
    this.userReaction = null;
    
    // ç»‘å®šä¸Šä¸‹æ–‡
    this.handleReactionClick = this.handleReactionClick.bind(this);
  }
  
  /**
   * åˆå§‹åŒ–ååº”ç»„ä»¶
   */
  async init() {
    if (!this.config.memoId) {
      console.error('ç¼ºå°‘memoIdå‚æ•°');
      return;
    }
    
    // åŠ è½½ç°æœ‰ååº”æ•°æ®
    await this.loadReactions();
  }
  
  /**
   * ä»APIåŠ è½½ååº”æ•°æ®
   */
  async loadReactions() {
    try {
      // å°è¯•ä½¿ç”¨memosè‡ªèº«APIè·å–ååº”
      const base = CONFIG.memos.baseUrl.replace(/\/$/, '');
      const urls = [
        `${base}/api/v1/memos/${this.config.memoId}/reactions`,
        `${base}/api/v1/memos/${this.config.memoId}/reactions`,
        `${base}/api/v1/memo/${this.config.memoId}/reactions`,
      ];
      
      let reactionsData = [];
      for (const u of urls) {
        try {
          const res = await fetch(u, {
            mode: 'cors',
            credentials: 'include', // æºå¸¦è®¤è¯Cookie
            headers: { 'Accept': 'application/json' }
          });
          // å³ä½¿é200çŠ¶æ€ä¹Ÿå°è¯•è§£æï¼ˆæœåŠ¡å™¨å¯èƒ½è¿”å›æ•°æ®ï¼‰
          const json = await res.json();
          reactionsData = Array.isArray(json) ? json : (json.reactions || []);
          break;
        } catch (e) {}
      }
      
      // å¤„ç†ååº”æ•°æ®ï¼ˆä¼˜å…ˆä½¿ç”¨reactionTypeå­—æ®µï¼‰
      this.reactions = {};
      reactionsData.forEach(r => {
        const t = (r && r.reactionType) || ''; // åŒ¹é…APIè¿”å›çš„reactionType
        if (!t) return;
        this.reactions[t] = (this.reactions[t] || 0) + 1;
      });
      
      // æ¸²æŸ“ååº”ç»„ä»¶
      this.render();
    } catch (error) {
      console.error('åŠ è½½ååº”æ—¶å‡ºé”™:', error);
    }
  }
  
  /**
   * æ¸²æŸ“ååº”ç»„ä»¶
   * @returns {HTMLElement} ååº”ç»„ä»¶DOM
   */
  render() {
    // æ¸…ç©ºå®¹å™¨
    if (this.container) {
      this.container.innerHTML = '';
    } else {
      // å¦‚æœæ²¡æœ‰å®¹å™¨ï¼Œå°è¯•æŸ¥æ‰¾
      this.container = document.querySelector(`.memos-item[data-id="${this.config.memoId}"] .emaction-container`);
      if (!this.container) return;
    }
    
    this.emojis.forEach(emoji => {
      const count = this.reactions[emoji.type] || 0;
      const button = document.createElement('button');
      
      // è®¾ç½®æŒ‰é’®æ ·å¼
      button.className = `emaction-btn ${this.userReaction === emoji.type ? 'active' : ''}`;
      button.innerHTML = `${emoji.code} ${count > 0 ? count : ''}`;
      button.dataset.emoji = emoji.type; // ä½¿ç”¨emojiç±»å‹ä½œä¸ºæ ‡è¯†
      button.addEventListener('click', this.handleReactionClick);
      
      this.container.appendChild(button);
    });
    
    return this.container;
  }
  
  /**
   * å¤„ç†ååº”ç‚¹å‡»äº‹ä»¶
   */
  async handleReactionClick(e) {
    const emojiType = e.currentTarget.dataset.emoji;
    const isActive = this.userReaction === emojiType;
    
    // æ›´æ–°UIçŠ¶æ€
    this.userReaction = isActive ? null : emojiType;
    this.reactions[emojiType] = isActive 
      ? Math.max(0, (this.reactions[emojiType] || 0) - 1)
      : (this.reactions[emojiType] || 0) + 1;
    
    // é‡æ–°æ¸²æŸ“
    this.render();
    
    // æäº¤åˆ°API
    if (!isActive) {
      await this.submitReaction(emojiType);
    } else {
      // ç§»é™¤ååº”ï¼ˆæ ¹æ®å®é™…APIè°ƒæ•´åˆ é™¤é€»è¾‘ï¼‰
      console.log(`ç§»é™¤ååº”: ${emojiType}`);
    }
  }
  
  /**
   * æäº¤ååº”åˆ°API
   */
  async submitReaction(emojiType) {
    try {
      const base = CONFIG.memos.baseUrl.replace(/\/$/, '');
      const urls = [
        `${base}/api/v1/memos/${this.config.memoId}/reactions`,
        `${base}/api/v1/memos/${this.config.memoId}/reactions`,
        `${base}/api/v1/memo/${this.config.memoId}/reactions`,
      ];
      
      for (const u of urls) {
        try {
          const res = await fetch(u, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include', // æºå¸¦è®¤è¯Cookie
            mode: 'cors',
            body: JSON.stringify({ reactionType: emojiType }) // åŒ¹é…APIçš„reactionTypeå­—æ®µ
          });
          if (res.ok) return true;
        } catch (e) {}
      }
      
      // æäº¤å¤±è´¥æç¤ºç™»å½•
      alert('éœ€è¦ç™»å½•æ‰èƒ½è¡¨æ€å“¦~');
      window.open(`${CONFIG.memos.baseUrl}`, '_blank'); // è·³è½¬åˆ°Memosç™»å½•é¡µ
      return false;
    } catch (error) {
      console.error('æäº¤ååº”æ—¶å‡ºé”™:', error);
      // å¤±è´¥æ—¶å›æ»šçŠ¶æ€
      await this.loadReactions();
      return false;
    }
  }
}

const CONFIG = {
  memos: {
    baseUrl: 'https://memos.blueke.top/',
    limit: 10,
    creatorId: '1',
    username: 'lanke',
    userlink: 'https://memos.blueke.top',
    commentsShow: true,
    commentsTitle: 'è¯„è®º'
  },
  artalk: {
    site: 'Memos',
    server: 'https://artalk.blueke.top',
    commentsUrl: 'https://memos.blueke.top/m/'
  },
  dom: {
    gridContainer: '#memo-grid',
    template: '#memo-item-template',
    loadMore: '#load-more-container'
  }
};

let nextToken = '';
const limit = parseInt(CONFIG.memos.limit, 10);
const memoGrid = document.querySelector(CONFIG.dom.gridContainer);
const memoTemplate = document.querySelector(CONFIG.dom.template);
const loadMoreContainer = document.querySelector(CONFIG.dom.loadMore);

function formatDate(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hour = String(date.getHours()).padStart(2, '0');
  const minute = String(date.getMinutes()).padStart(2, '0');
  return `${year}-${month}-${day} ${hour}:${minute}`;
}

function renderMarkdownBasic(text) {
  if (!text) return '';
  let s = text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

  s = s.replace(/```([\s\S]*?)```/g, (_, code) => `<pre><code>${code.replace(/&/g, '&amp;')}</code></pre>`);
  s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
  s = s.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>')
       .replace(/^##\s+(.*)$/gm, '<h2>$1</h2>')
       .replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
  s = s.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
       .replace(/\*([^*]+)\*/g, '<em>$1</em>');
  s = s.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img alt="$1" src="$2" class="memo-img" />');
  s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" class="memo-link">$1</a>');
  s = s.replace(/^>\s+(.*)$/gm, '<blockquote>$1</blockquote>');
  s = s.replace(/^(?:-\s.*(?:\r?\n|$))+?/gm, (block) => {
    const items = block.trim().split(/\r?\n/).map(l => l.replace(/^-+\s?/, '').trim());
    const li = items.filter(Boolean).map(i => `<li>${i}</li>`).join('');
    return `<ul>${li}</ul>`;
  });
  s = s.split(/\n{2,}/).map(chunk => {
    if (/^\s*(<h\d|<ul|<pre|<blockquote|<img|<p)/.test(chunk)) return chunk;
    const lines = chunk.split(/\n/).map(l => l.trim()).filter(Boolean);
    if (!lines.length) return '';
    return `<p>${lines.join('<br/>')}</p>`;
  }).join('\n');

  return s;
}

function renderMemoItem(memo) {
  const isoTime = memo.displayTime || memo.createTime;
  const createdDate = isoTime ? new Date(isoTime) : new Date();
  const memoId = String(memo.id || (memo.name || '').split('/').pop() || Date.now());

  const frag = memoTemplate.content.cloneNode(true);
  const article = frag.firstElementChild;
  article.dataset.id = memoId; // æ·»åŠ data-idç”¨äºå…³è”ååº”ç»„ä»¶
  
  const contentEl = frag.querySelector('.memos-content');
  contentEl.innerHTML = renderMarkdownBasic(memo.content || '');
  contentEl.querySelectorAll('img').forEach(img => {
    const src = img.getAttribute('src') || '';
    if (/^\/(attachments|resources|o)\//.test(src)) {
      img.src = `${CONFIG.memos.baseUrl}${src.slice(1)}`;
    } else if (/^(attachments|resources|o)\//.test(src)) {
      img.src = `${CONFIG.memos.baseUrl}${src}`;
    }
  });
  if (Array.isArray(memo.attachments) && memo.attachments.length) {
    const wrap = document.createElement('div');
    wrap.className = 'memos-attachments';
    memo.attachments.forEach(att => {
      const id = (att.name || '').split('/').pop();
      const isImg = (att.type || '').startsWith('image/');
      if (isImg) {
        const candidates = [];
        if (att.externalLink) candidates.push(att.externalLink);
        if (id) {
          candidates.push(`${CONFIG.memos.baseUrl}api/v1/attachments/${id}/raw`);
          candidates.push(`${CONFIG.memos.baseUrl}api/v1/attachments/${id}/raw`);
          candidates.push(`${CONFIG.memos.baseUrl}o/${id}`);
        }
        const img = document.createElement('img');
        img.className = 'memo-img';
        let i = 0;
        const tryNext = () => {
          if (i >= candidates.length) return;
          img.src = candidates[i++];
        };
        img.addEventListener('error', tryNext);
        tryNext();
        wrap.appendChild(img);
      } else {
        const a = document.createElement('a');
        a.href = att.externalLink || (id ? `${CONFIG.memos.baseUrl}api/v1/attachments/${id}/raw` : '#');
        a.textContent = att.filename || 'é™„ä»¶';
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.className = 'memo-link';
        wrap.appendChild(a);
      }
    });
    contentEl.appendChild(wrap);
  }
  frag.querySelector('.memos-time').textContent = formatDate(createdDate);
  
  const commentBtn = frag.querySelector('.memos-comments');
  const commentCount = frag.querySelector('.artalk-count');
  const reactionBtn = frag.querySelector('.memos-reactions');
  commentBtn.setAttribute('data-id', memoId);
  commentCount.setAttribute('data-page-key', `/m/${memoId}`);
  reactionBtn.setAttribute('data-id', memoId);
  frag.querySelector('.comment').id = memoId;

  commentBtn.addEventListener('click', () => loadArtalk(commentBtn));
  reactionBtn.addEventListener('click', () => loadReactions(reactionBtn));
  
  // åˆå§‹åŒ–ååº”ç»„ä»¶
  const emaction = new Emaction({
    memoId: memoId,
    emactionApi: CONFIG.memos.baseUrl
  });
  emaction.init();
  
  return frag;
}

async function ensureArtalk() {
  if (!document.querySelector('link[href="https://unpkg.com/artalk@2.9.1/dist/Artalk.css"]')) {
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://unpkg.com/artalk@2.9.1/dist/Artalk.css';
    document.head.appendChild(link);
  }
  if (window.__Artalk) return window.__Artalk;
  const mod = await import('https://esm.sh/artalk@2.9.1');
  const Artalk = mod.default || mod;
  window.__Artalk = Artalk;
  return Artalk;
}

async function loadArtalk(btn) {
  const id = btn.getAttribute('data-id') || '';
  const container = document.getElementById('memos-comment-global');
  if (!container) return;

  if (window.__memosCommentId === id && !container.classList.contains('d-none')) {
    container.classList.add('d-none');
    container.innerHTML = '';
    window.__memosCommentId = null;
    return;
  }

  container.classList.remove('d-none');
  container.innerHTML = '<div id="artalk"></div>';

  const Artalk = await ensureArtalk();
  Artalk.init({
    el: '#artalk',
    pageKey: `/m/${id}`,
    pageTitle: '',
    site: CONFIG.artalk.site,
    server: CONFIG.artalk.server,
    emoticons: false
  });

  window.__memosCommentId = id;
  container.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

const REACTIONS = [
  {type:'ğŸ‘', emoji:'ğŸ‘'},
  {type:'â¤ï¸', emoji:'â¤ï¸'},
  {type:'ğŸ˜„', emoji:'ğŸ˜„'},
  {type:'ğŸ‰', emoji:'ğŸ‰'},
  {type:'ğŸ˜•', emoji:'ğŸ˜•'},
  {type:'ğŸ‘€', emoji:'ğŸ‘€'}
];

async function fetchReactions(id) {
  const base = CONFIG.memos.baseUrl.replace(/\/$/, '');
  const urls = [
    `${base}/api/v1/memos/${id}/reactions`,
    `${base}/api/v1/memos/${id}/reactions`,
    `${base}/api/v1/memo/${id}/reactions`,
  ];
  for (const u of urls) {
    try {
      const res = await fetch(u, {
        mode: 'cors',
        credentials: 'include', // æºå¸¦è®¤è¯Cookie
        headers: { 'Accept': 'application/json' }
      });
      const json = await res.json();
      const reactions = Array.isArray(json) ? json : (json.reactions || []);
      return { reactions };
    } catch (e) {}
  }
  return { reactions: [] };
}

async function postReaction(id, reactionType) {
  const base = CONFIG.memos.baseUrl.replace(/\/$/, '');
  const urls = [
    `${base}/api/v1/memos/${id}/reactions`,
    `${base}/api/v1/memos/${id}/reactions`,
    `${base}/api/v1/memo/${id}/reactions`,
  ];
  for (const u of urls) {
    try {
      const res = await fetch(u, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        credentials: 'include', // æºå¸¦è®¤è¯Cookie
        mode: 'cors',
        body: JSON.stringify({ reactionType }) // åŒ¹é…APIçš„reactionTypeå­—æ®µ
      });
      if (res.ok) return true;
    } catch (e) {}
  }
  return false;
}

async function loadReactions(btn) {
  const id = btn.getAttribute('data-id') || '';
  const container = document.getElementById('memos-reaction-global');
  if (!container) return;
  if (window.__memosReactionId === id && !container.classList.contains('d-none')) {
    container.classList.add('d-none');
    container.innerHTML = '';
    window.__memosReactionId = null;
    return;
  }
  container.classList.remove('d-none');
  container.innerHTML = '<div class="reaction-bar"></div>';
  const bar = container.querySelector('.reaction-bar');
  const data = await fetchReactions(id);
  const counts = {};
  if (data && Array.isArray(data.reactions)) {
    data.reactions.forEach(r => {
      const t = (r && r.reactionType) || ''; // åŒ¹é…APIçš„reactionType
      if (!t) return;
      counts[t] = (counts[t] || 0) + 1;
    });
  }
  const types = Object.keys(counts);
  if (!types.length) {
    const link = document.createElement('a');
    link.href = `${CONFIG.memos.userlink}/m/${id}`;
    link.target = '_blank';
    link.rel = 'noopener noreferrer';
    link.className = 'memo-link';
    link.textContent = 'æš‚æ— è¡¨æ€ï¼Œå‰å¾€ Memos è¡¨æ€';
    bar.appendChild(link);
  } else {
    const emojiMap = { 'ğŸ‘':'ğŸ‘', 'â¤ï¸':'â¤ï¸', 'ğŸ˜„':'ğŸ˜„', 'ğŸ‰':'ğŸ‰', 'ğŸ˜•':'ğŸ˜•', 'ğŸ‘€':'ğŸ‘€' };
    types.forEach(t => {
      const btnEl = document.createElement('button');
      btnEl.className = 'reaction-chip';
      btnEl.textContent = `${(emojiMap[t]||'ğŸ™‚')} ${counts[t]}`;
      btnEl.addEventListener('click', async (e) => {
        e.stopPropagation();
        const ok = await postReaction(id, t);
        if (!ok) {
          alert('éœ€è¦ç™»å½•æ‰èƒ½è¡¨æ€å“¦~');
          window.open(`${CONFIG.memos.baseUrl}`, '_blank');
          return;
        }
        const latest = await fetchReactions(id);
        const n = latest && Array.isArray(latest.reactions)
          ? latest.reactions.filter(x => x.reactionType === t).length
          : counts[t]+1;
        btnEl.textContent = `${(emojiMap[t]||'ğŸ™‚')} ${n}`;
      });
      bar.appendChild(btnEl);
    });
  }
  window.__memosReactionId = id;
  container.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function updateMemoList(data = []) {
  if (!memoGrid || data.length === 0) return;
  data.forEach(memo => memoGrid.appendChild(renderMemoItem(memo)));
  ensureArtalk().then(Artalk => {
    Artalk.loadCountWidget({
      server: CONFIG.artalk.server,
      site: CONFIG.artalk.site,
      countEl: '.artalk-count'
    });
  });
}

function initLoadMoreBtn() {
  loadMoreContainer.innerHTML = '<button class="load-btn button-load">åŠ è½½ä¸­â€¦</button>';
  const btn = loadMoreContainer.querySelector('.button-load');
  btn.addEventListener('click', () => {
    btn.textContent = 'åŠ è½½ä¸­â€¦';
    getNextPageMemos().then(() => btn.textContent = 'åŠ è½½æ›´å¤š');
  });
  return btn;
}

async function getFirstPageMemos() {
  const btn = initLoadMoreBtn();
  const url = `${CONFIG.memos.baseUrl}api/v1/memos?creatorId=${CONFIG.memos.creatorId}&rowStatus=NORMAL&limit=${limit}`;
  try {
    const res = await fetch(url);
    const resdata = await res.json();
    const list = Array.isArray(resdata) ? resdata : (resdata.memos || []);
    nextToken = resdata?.nextPageToken || '';
    updateMemoList(list);
    if (!nextToken || list.length < limit) loadMoreContainer.innerHTML = '';
    else btn.textContent = 'åŠ è½½æ›´å¤š';
  } catch (err) {
    console.error('åˆå§‹åŠ è½½å¤±è´¥:', err);
    memoGrid.innerHTML = '<div class="memo-error">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</div>';
    loadMoreContainer.innerHTML = '';
  }
}

async function getNextPageMemos() {
  if (!nextToken) {
    loadMoreContainer.innerHTML = '';
    return;
  }
  const url = `${CONFIG.memos.baseUrl}api/v1/memos?creatorId=${CONFIG.memos.creatorId}&rowStatus=NORMAL&limit=${limit}&pageToken=${encodeURIComponent(nextToken)}`;
  try {
    const res = await fetch(url);
    const resdata = await res.json();
    const list = Array.isArray(resdata) ? resdata : (resdata.memos || []);
    nextToken = resdata?.nextPageToken || '';
    updateMemoList(list);
    if (!nextToken || list.length < 1) loadMoreContainer.innerHTML = '';
    const Artalk = await ensureArtalk();
    Artalk.loadCountWidget({
      server: CONFIG.artalk.server,
      site: CONFIG.artalk.site,
      countEl: '.artalk-count'
    });
  } catch (err) {
    console.error('åˆ†é¡µåŠ è½½å¤±è´¥:', err);
    loadMoreContainer.innerHTML = '<div class="memo-error">åŠ è½½æ›´å¤šå¤±è´¥</div>';
  }
}

// ç‚¹å‡»é¡µé¢ç©ºç™½å¤„å…³é—­è¯„è®ºå®¹å™¨ä¸ååº”æµ®å±‚
document.addEventListener('click', (e) => {
  const t = e.target;
  const c1 = document.getElementById('memos-comment-global');
  const pop = document.getElementById('memos-reaction-popover');
  const insideComment = !!t.closest('#memos-comment-global');
  const insidePopover = !!t.closest('#memos-reaction-popover');
  const isBtn = !!t.closest('.memos-comments') || !!t.closest('.memos-reactions') || !!t.closest('.emaction-btn');
  if (insideComment || insidePopover || isBtn) return;
  if (c1 && !c1.classList.contains('d-none')) { c1.classList.add('d-none'); c1.innerHTML=''; (window).__memosCommentId=null; }
  if (pop && !pop.classList.contains('d-none')) { pop.classList.add('d-none'); pop.innerHTML=''; }
});

if (memoGrid && memoTemplate) getFirstPageMemos();
</script>
  </div>
</MainLayout>

<style is:inline>
  :root {
    --color-border: var(--line-divider);
    --color-bg-1: var(--content-pane-bg);
    --text-muted: var(--text-secondary);
    --color-link: var(--text-link);
    --grid-gap: 16px;
    --card-min-width: 220px;
  }

  .dark {
    --color-border: var(--line-divider);
    --color-bg-1: var(--content-pane-bg);
    --text-muted: var(--text-secondary);
    --color-link: var(--text-link);
  }

  .memos {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .memos .page-title {
    margin: 0 !important;
    font-size: 1.1rem !important;
    line-height: 1.15 !important;
    display: inline-flex !important;
    align-items: center;
    gap: 0.25rem !important;
  }

  .memos .page-title :global(svg) {
    width: 1rem !important;
    height: 1rem !important;
  }

  .memos .page-subtitle {
    margin: 0.12rem 0 0.4rem !important;
    font-size: 0.85rem !important;
    line-height: 1.2 !important;
  }

  .d-none { display: none !important; }

  /* å¤šåˆ—å¸ƒå±€ä¿æŒä¸å˜ */
  .memos-list {
    margin-top: 0.4rem;
  }

  .memos-grid {
    column-count: 4;
    column-gap: var(--grid-gap);
    width: 100%;
    column-width: var(--card-min-width);
  }

  /* å¡ç‰‡æ ·å¼ä¿æŒä¸å˜ */
  .memos-item {
    display: flex;
    flex-direction: column;
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 12px 14px;
    background: var(--color-bg-1);
    transition: box-shadow 0.2s ease;
    break-inside: avoid;
    margin-bottom: var(--grid-gap);
  }

  .memos-item:hover {
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
  }

  /* å†…å®¹åŒºåŸŸï¼šç¼©å°æ•´ä½“å­—ä½“åŸºæ•° */
  .memos-content.prose {
    font-size: 1rem !important;
    line-height: 1.5 !important;
    color: var(--text-primary) !important;
    margin: 0 !important;
    padding: 0 !important;
    flex: 1;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    word-break: break-all !important;
    white-space: normal !important;
  }

  .memos-content.prose h1,
  .memos-content.prose h2,
  .memos-content.prose h3 {
    margin: 0.3rem 0 0.15rem !important;
    font-size: 1.1rem !important;
    font-weight: 500 !important;
    line-height: 1.4 !important;
  }

  /* æ®µè½æ ·å¼ï¼šåŒæ­¥ç¼©å°é—´è· */
  .memos-content.prose p {
    margin: 0.2rem 0 !important;
  }

  .memos-content.prose ul {
  margin: 0.2rem 0 0.3rem 0.4rem !important; 
  padding-left: 1.2rem !important; 
  margin-left: 0 !important;
}

.memos-content.prose li {
  margin: 0.1rem 0 !important; 
  font-size: 0.86rem !important;
  line-height: 1.45 !important;
  text-indent: -0.5em !important; 
  padding-left: 0.5em !important;
}

.memos-content.prose li::marker {
  font-size: 0.9em !important;
}

  .memos-content.prose blockquote {
    margin: 0.3rem 0 !important;
    padding: 0.2rem 0.5rem !important;
    font-size: 0.84rem !important;
  }

  /* å›¾ç‰‡æ ·å¼ä¿æŒä¸å˜ */
  .memo-img {
    max-width: 100% !important;
    height: auto !important;
    border-radius: 6px !important;
    margin: 0.3rem 0 !important;
  }

  /* é“¾æ¥æ ·å¼ï¼šåŒæ­¥ç¼©å° */
  .memo-link {
    color: var(--color-link) !important;
    text-decoration: underline !important;
    display: inline-block !important;
    font-size: 0.86rem !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
  }

  .comment-global,
  .reaction-global {
    width: 100%;
    margin: 0.6rem 0;
    padding: 0.6rem;
    border: 1px solid var(--color-border);
    border-radius: 12px;
    background: var(--color-bg-1);
  }

  .reaction-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    margin: 4px 6px 0 0;
    border: 1px solid var(--line-divider);
    border-radius: 999px;
    background: var(--tag-bg);
    color: var(--text-primary);
    cursor: pointer;
    transition: background-color 0.2s ease, border-color 0.2s ease;
  }
  .reaction-chip:hover {
    background: var(--theme-color);
    border-color: var(--theme-color);
    color: #fff;
  }

  /* ååº”ç»„ä»¶æ ·å¼ */
  .emaction-container {
    display: flex;
    gap: 0.3rem;
    margin: 0.5rem 0;
    flex-wrap: wrap;
  }

  .emaction-btn {
    border: none;
    background: transparent;
    cursor: pointer;
    padding: 0.2rem 0.4rem;
    border-radius: 999px;
    display: flex;
    align-items: center;
    gap: 0.2rem;
    transition: all 0.2s ease;
    font-size: 0.85rem;
    border: 1px solid transparent;
  }

  .emaction-btn:hover {
    background: rgba(102, 126, 234, 0.05);
    border-color: rgba(102, 126, 234, 0.2);
  }

  .emaction-btn.active {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
    border-color: rgba(102, 126, 234, 0.3);
  }

  [data-user-color-scheme="dark"] .emaction-btn.active {
    background: rgba(21, 137, 233, 0.2);
    color: var(--post-link-color);
    border-color: rgba(21, 137, 233, 0.4);
  }

  [data-user-color-scheme="dark"] .emaction-btn:hover {
    background: rgba(21, 137, 233, 0.1);
    border-color: rgba(21, 137, 233, 0.2);
  }

  /* åº•éƒ¨åŒºåŸŸä¿æŒä¸å˜ */
  .memos-footer {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 8px;
    margin-top: auto;
    padding-top: 0.5rem !important;
    border-top: 1px solid var(--color-border);
    line-height: 1 !important;
  }

  .memos-time {
    font-size: 0.7rem !important;
    color: var(--text-muted);
    white-space: nowrap;
  }

  /* æŒ‰é’®æ ·å¼ */
  .memos-reactions,
  .memos-comments {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 0.75rem !important;
    color: var(--theme-color);
    background: var(--tag-bg);
    border: 1px solid var(--line-divider);
    padding-left: 8px !important;
    padding-right: 8px !important;
    padding-top: 4px !important;
    padding-bottom: 4px !important;
    margin: 0 !important;
    margin-left: auto !important;
    border-radius: 8px !important;
    cursor: pointer;
    transition: all 0.2s ease !important;
    box-sizing: border-box !important;
    white-space: nowrap !important;
    text-align: center !important;
    outline: none !important;
    appearance: none !important;
  }

  .memos-comments .artalk-count {
    margin-left: 3px !important;
    margin-right: 0 !important;
    padding: 0 !important;
  }

  .memos-comments:hover,
  .memos-reactions:hover {
    background: var(--theme-color);
    border-color: var(--theme-color);
    color: #fff;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
  }

  /* åŠ è½½æ›´å¤šæŒ‰é’®ä¿æŒä¸å˜ */
  .bb-load {
    margin: 1rem 0 2rem;
    column-span: all;
  }

  .button-load {
    width: 100% !important;
    font-size: 0.8rem;
    background: none;
    border-radius: 10px;
    border: 1px solid var(--color-border);
    padding: 10px 30px;
    letter-spacing: 0.8rem;
    text-align: center;
    color: var(--text-muted);
    cursor: pointer;
    transition: border-color 0.2s ease;
  }

  .button-load:hover {
    border-color: var(--color-link);
    color: var(--color-link);
  }

  /* é”™è¯¯æç¤ºä¿æŒä¸å˜ */
  .memo-error {
    text-align: center;
    color: #ef4444;
    padding: 1rem;
    font-size: 0.9rem;
    column-span: all;
  }

  /* å“åº”å¼é€‚é…ä¿æŒä¸å˜ */
  @media (max-width: 1024px) {
    .memos-grid {
      column-count: 2;
    }
  }

  @media (max-width: 640px) {
    .memos-grid {
      column-count: 1;
    }

    .memos-item {
      padding: 10px 12px;
      margin-bottom: 12px;
    }

    .memos-content.prose {
      font-size: 0.86rem !important;
    }

    .memos-content.prose h1,
    .memos-content.prose h2,
    .memos-content.prose h3 {
      font-size: 0.9rem !important;
    }

    .memos-time, .memos-comments, .memos-reactions {
      font-size: 0.68rem !important;
    }

    .emaction-btn {
      font-size: 0.8rem;
      padding: 0.15rem 0.35rem;
    }
  }
</style>