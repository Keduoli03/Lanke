---
import { type CollectionEntry, getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import PostLayout from '../../layouts/PostLayout.astro';
import License from '@/components/post/License.astro';
import PostHeader from '@/components/post/PostHeader.astro';
import { render } from 'astro:content';
import Markdown from '@/components/util/Markdown.astro';
import { siteConfig } from '@/config';
import Artalk from '@/components/util/Artalk.astro';
import AiSummary from '@/components/util/AiSummary.astro';
// 引入需要插入侧边插槽的组件
import Toc from '@/components/post/Toc.astro';
import ScrollToTop from '@/components/util/ScrollToTop.astro';
import ScrollToComment from '@/components/util/ScrollToComment.astro';
import Live2D from '@/components/util/Live2D.astro';

export const prerender = true;

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map(entry => ({
    params: { slug: entry.data.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content, headings, remarkPluginFrontmatter } = await render(entry);
const fullPostUrl = Astro.url.href;

// 过滤掉 footnotes 标题，避免在目录中显示
const filteredHeadings = headings.filter(h => h.slug !== 'footnote-label' && h.text !== 'Footnotes');
---

<PostLayout 
  title={entry.data.title} 
  description={entry.data.description}
  railWidth={siteConfig.tocWidth} // 可选：自定义侧边插槽宽度
>
  {entry.data.cover && (
    <div class="hero-image mb-4 sm:mb-6 lg:mb-8" transition:name={`hero-${entry.data.slug}`}>
      <Image 
        width={1020} 
        height={510} 
        src={entry.data.cover} 
        alt={entry.data.title}
        class="w-full h-auto rounded-lg shadow-lg"
      />
    </div>
  )}
  
  <div class="mt-4 lg:mt-0">
    <PostHeader post={entry} transition:name={`title-${entry.data.slug}`} />
  </div>
  <div style="display:none">
    <span data-pagefind-meta={`date:${new Date(entry.data.date).toISOString()}`}></span>
    {entry.data.updated && (
      <span data-pagefind-meta={`updated:${new Date(entry.data.updated).toISOString()}`}></span>
    )}
  </div>
  
  {entry.data.aiSummary && (
    <AiSummary 
      slug={entry.data.slug} 
      title={entry.data.title} 
      body={entry.body} 
    />
  )}
  
  <Markdown>
    <Content />
  </Markdown>

  <License title={entry.data.title} postUrl={fullPostUrl} pubDate={entry.data.date} />

  <div id="comment-section" class="mt-10">
    <Artalk />
  </div>


  <div slot="rail">
    
    <Toc items={filteredHeadings} />
    <div class="rail-actions">
      <ScrollToTop />
      <ScrollToComment />
    </div>
  </div>
</PostLayout>
<style>
  .rail-actions{
    margin-top: auto;
    margin-left: 1rem;
    padding-top: 16rem;
  }

  @media (min-width: 1024px) and (max-width: 1440px) {
    .rail-actions {
      margin-left: 1rem;
      padding-top: 6rem; 
    }
  }
</style>