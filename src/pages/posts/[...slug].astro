---
import { type CollectionEntry, getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import PostLayout from '../../layouts/PostLayout.astro';
import PostInfoCard from '../../components/post/PostInfoCard.astro';
import PostHeader from '@/components/post/PostHeader.astro';
import { render } from 'astro:content';
import Markdown from '@/components/util/Markdown.astro';
import { siteConfig } from '@/config';
import Artalk from '@/components/util/Artalk.astro';
import AiSummary from '@/components/util/AiSummary.astro';
// 引入需要插入侧边插槽的组件
import Toc from '@/components/post/Toc.astro';
import ScrollToTop from '@/components/util/ScrollToTop.astro';
import ScrollToComment from '@/components/util/ScrollToComment.astro';

export const prerender = true;

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map(entry => ({
    params: { slug: entry.data.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content, headings, remarkPluginFrontmatter } = await render(entry);
const fullPostUrl = Astro.url.href;
---

<PostLayout 
  title={entry.data.title} 
  description={entry.data.description}
  railWidth={siteConfig.tocWidth} // 可选：自定义侧边插槽宽度
>
  {/* 主内容插槽：文章主体内容（和原来一致） */}
  {entry.data.cover && (
    <div class="hero-image mb-4 sm:mb-6 lg:mb-8" transition:name={`hero-${entry.data.slug}`}>
      <Image 
        width={1020} 
        height={510} 
        src={entry.data.cover} 
        alt={entry.data.title}
        class="w-full h-auto rounded-lg shadow-lg"
      />
    </div>
  )}
  
  <PostHeader post={entry} transition:name={`title-${entry.data.slug}`} />
  <div style="display:none">
    <span data-pagefind-meta={`date:${new Date(entry.data.date).toISOString()}`}></span>
    {entry.data.updated && (
      <span data-pagefind-meta={`updated:${new Date(entry.data.updated).toISOString()}`}></span>
    )}
  </div>
  
  {entry.data.aiSummary && (
    <AiSummary 
      slug={entry.data.slug} 
      title={entry.data.title} 
      body={entry.body} 
    />
  )}
  
  <Markdown>
    <Content />
  </Markdown>

  <PostInfoCard postUrl={fullPostUrl} />

  <div id="comment-section" class="mt-10">
    <Artalk />
  </div>


  <div slot="rail">
    <Toc items={headings} />
    <div class="rail-actions">
      <ScrollToTop />
      <ScrollToComment />
    </div>
  </div>
</PostLayout>
<style>
  .rail-actions{
    margin-top: 20rem;
    margin-left: 3rem;
  }
</style>