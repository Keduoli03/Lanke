---
import { type CollectionEntry, getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import MainLayout from '../../layouts/MainLayout.astro';
import Toc from '../../components/post/Toc.astro';
import PostInfoCard from '../../components/post/PostInfoCard.astro';
import PostHeader from '@/components/post/PostHeader.astro';
import { render } from 'astro:content';
import Markdown from '@/components/util/Markdown.astro';
import { siteConfig } from '@/config';
import ScrollToTop from '@/components/util/ScrollToTop.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map(entry => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

const { entry, } = Astro.props;
const { Content, headings, remarkPluginFrontmatter } = await render(entry);
const fullPostUrl = Astro.url.href;
---
<MainLayout 
    title={entry.data.title} 
    description={entry.data.description}
    
    >
  {/* 容器保持居中 */}
  <div class="w-full flex justify-center px-4 py-8">
    <div class="w-full max-w-7xl flex flex-col lg:flex-row gap-x-12 gap-y-8" style={`--toc-width: ${siteConfig.tocWidth}`}>
      {/* 文章区域 */}
      <article class="min-w-0 flex-1">
        {entry.data.cover && (
          <div class="hero-image mb-8" transition:name={`hero-${entry.data.slug}`}>
            <Image 
              width={1020} 
              height={510} 
              src={entry.data.cover} 
              alt={entry.data.title}
              class="w-full h-auto rounded-lg shadow-lg"
            />
          </div>
        )}
        
        <PostHeader post={entry} transition:name={`title-${entry.data.slug}`} />
      
        <Markdown>
          <Content />
        </Markdown>
      </article>
      
      {/* 目录区域 */}
      <aside class="hidden lg:block w-60 flex-shrink-0">
        <div class="sticky top-20 flex flex-col" style="height: calc(100vh - 20rem);">
          <div class="overflow-y-auto pr-4">
            <Toc items={headings} />
          </div>
          <div class="mt-auto flex-shrink-0 flex justify-center py-4">
            <ScrollToTop />
          </div>
        </div>
      </aside>
    </div>
  </div>
  <PostInfoCard postUrl={fullPostUrl} />
</MainLayout>

<style>
  .flex-row {
    align-items: flex-start;
    overflow: visible !important;
  }
</style>
